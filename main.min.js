function microSurvivors(m=document.body,L=400,c=400){let h=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],N=L/2,U=c/2,{floor:H,ceil:w,random:M,round:g,cos:W,sin:$,min:O,hypot:K,abs:Y,atan2:Z,PI:u}=Math,G=2*u;var e="Press ENTER to ";let v=e+"start",x=e+"restart",S=(e,a=2,t="0")=>e.toString().padStart(a,t);function R(e){var a=H(e/60),e=H(e%60);return S(a)+":"+S(e)}let T=e=>l(e*(180/u)),l=(e,a=0)=>e.toFixed(a),ee=(e,a,t,r)=>K(t-e,r-a);let ae=e=>e[g(M()*(e.length-1))],k={rect(e,a,t,r,s){y.fillStyle=s,y.fillRect(e,a,t,r)},t(e="rgba(0,0,0,0.9)"){y.fillStyle=e,y.fillRect(0,0,L,c)},i(e,a,t,r){y.fillStyle=r,y.fillRect(e-t/2,a-t/2,t,t)},o(e,a,t,r){y.fillStyle=r,y.beginPath(),y.moveTo(e,a-t/2),y.lineTo(e-t/2,a+t/2),y.lineTo(e+t/2,a+t/2),y.fill()},text(e,a,t,r,s="left",n="top",i=14){y.font=i+"px monospace",y.fillStyle=r,y.textAlign=s,y.textBaseline=n,y.fillText(t,e,a)},l(e,a,t,r){y.fillStyle=r,y.beginPath(),y.arc(e,a,t,0,G),y.fill()}},E=(e,a,t,r,s)=>{var n,i,o=a,c=t/2;15*s.length<r&&(e+=t/4);for([n,i]of s)k.text(e,a,n+":","#aaa"),k.text(e+c-5,a,""+i,"#fff","right"),o+r<(a+=15)&&(a=o,e+=c)},D=(e,a,t)=>{e=y.createRadialGradient(N,U,e,N,U,N);return e.addColorStop(0,a),e.addColorStop(1,t),e},b=document.createElement("canvas"),y=(b.width=L,b.height=c,b.getContext("2d")??(()=>{throw new Error})()),A={arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",w:"up",s:"down",a:"left",d:"right",enter:"enter",escape:"pause",p:"pause"},V={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},X={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},z=(e,a)=>{e=A[e.key.toLowerCase()];e&&(V[e]=a,X[e]=a)};e="addEventListener";document[e]("keydown",e=>z(e,!0)),document[e]("keyup",e=>z(e,!1)),b[e]("mousemove",e=>{var a=b.getBoundingClientRect();V.targetX=e.clientX-a.left,V.targetY=e.clientY-a.top});let q={m:0,h:1,g:2};var e=a=>{let t=a[0];var r=[a[0]];for(let e=1;e<a.length;e++)t={...t,...a[e]},r[e]=t;return r},a={name:"Saw Blades",type:q.m,v:e([{damage:5,range:50,rotationSpeed:u/2,u:.1,blades:1,size:10},{blades:2},{damage:10,rotationSpeed:u/1.5},{rotationSpeed:u/1.25,size:15},{blades:3},{damage:15},{blades:4}])},t={name:"Sword",type:q.h,v:e([{damage:8,angle:u/4,range:80,k:.5},{damage:13},{angle:u/4*1.2,range:90},{damage:18},{damage:23},{damage:28,angle:u/4*1.5},{damage:33,angle:u/4*1.7,range:120}])},e={name:"Barbed Wire",type:q.g,v:e([{range:40,damage:2,k:.75},{range:60},{damage:3},{range:70},{range:80},{damage:4}])};let C=e=>({type:e,S:0,R:0,level:0});var r=t=>(e,a)=>a+e.level*t,s=e=>()=>e;let te={T:[t],D:{health:[s(100),r(10)],speed:[s(45),r(.2)],healthRegen:[s(.1),r(.01)],pickupDistance:[s(50)],damage:[r(.3)],attackSpeed:[s(1)],healthDrop:[s(.01)]}};var r=(a,t)=>e=>e.D[a].push("base",(e,a)=>a+t),s=(a,t)=>e=>e.D[a].push("multiplier",(e,a)=>a*t),n=(o,e)=>{let c;return{name:e,description:()=>{var e=c?.A??F.T.find(e=>e.type===o);if(!e)return"New weapon";if(c?.level===e.level)return c.C;var a,t,r=e.type.v[e.level],s=e.type.v[e.level+1],n=[];for(a in s)s[a]!==r[a]&&(t=s[a]-r[a],t="angle"===a?T(t)+"°":l(t),n.push(`+${t} `+a));var i=n.join(", ");return c={level:e.level,A:e,C:i},i},weight:1,apply:e=>{var a=e.T.find(e=>e.type===o);a?a.level++:e.T.push(C(o))},B:o.v.length}};let re=[{name:"Speed boost",description:"+25% speed",weight:1,apply:s("speed",1.25),B:5},{name:"Speed base",description:"+1 base speed",weight:1,apply:r("speed",1),B:5},{name:"Heal",description:"+25 health",weight:1,P:e=>e.health+25<e.D.health.value,apply:e=>e.health+=25,B:5},{name:"Max health",description:"+25 max health, +5 health",weight:1,apply:e=>{e.D.health.push("base",(e,a)=>a+25),e.health+=5},B:5},{name:"Health drop",description:"+1% health drop chance",weight:1,apply:r("healthDrop",.01),B:5},{name:"Regen",description:"+0.1/s health regen",weight:1,apply:r("healthRegen",.1),B:5},{name:"Regen boost",description:"+5% health regen",weight:1,apply:s("healthRegen",1.05),B:5},{name:"Pickup range",description:"+10 pickup range",weight:1,apply:r("pickupDistance",10),B:5},{name:"Damage",description:"+1 damage",weight:1,apply:r("damage",1),B:5},{name:"Attack speed",description:"+5% attack speed",weight:1,apply:r("attackSpeed",-.05),B:5},n(a,"Saw Blades"),n(t,"Sword"),n(e,"Barbed Wire")],i=(e=[],a=[])=>({push(e,a){this[e]=[...this[e],a]},base:[...e],multiplier:[...a],I:null,get value(){var e;return this.I?.base===this.base&&this.I?.multiplier===this.multiplier&&this.I?.L===F.level?this.I.value:(e=this.base.reduce((e,a)=>a(F,e),0)*this.multiplier.reduce((e,a)=>a(F,e),1),this.I={base:this.base,multiplier:this.multiplier,L:F.level,value:e},e)}}),se=e=>({type:e,x:0,y:0,level:0,N:0,U:5,health:100,H:0,M:0,W:0,$:0,D:{speed:i(e.D.speed),health:i(e.D.health),healthRegen:i(e.D.healthRegen),pickupDistance:i(e.D.pickupDistance),damage:i(e.D.damage),attackSpeed:i(e.D.attackSpeed),healthDrop:i(e.D.healthDrop)},O:[],T:e.T.map(e=>C(e))}),F=se(te),_={RUNNING:0,K:1,Y:2,G:3,WIN:4,V:5},ne={X:-1,runtime:0,q:0,F:0,_:0,O:[],j:0},j={state:_.V,...ne};let o=(e,n)=>(t,r,s)=>e.map((e,a)=>k.i(t+a,r+a,n,s??e));var s=(e,n)=>(t,r,s)=>e.map((e,a)=>k.o(t+a,r+a,n,s??e)),r=(e,n)=>(t,r,s)=>e.map((e,a)=>k.l(t+a,r+a,n,s??e)),a={health:10,speed:26,damage:1,R:1,N:1,size:10,J:o(["#aaa"],10)},t={health:50,speed:26,damage:1,R:1,N:2,size:10,J:o(["#aaa","#faa"],10)},n={health:100,speed:30,damage:2,R:1,N:3,size:10,J:o(["#aaa","#faa","#4a4"],10)},e={health:20,speed:35,damage:2,R:1,N:2,size:10,J:s(["#999"],10)},B={health:40,speed:35,damage:2,R:1,N:3,size:10,J:s(["#999","#0ac"],10)},p={health:60,speed:35,damage:3,R:1,N:4,size:10,J:s(["#999","#0ac","#966"],10)},s={health:1e3,speed:35,damage:10,R:1,N:50,Z:!0,ee:80,size:20,J:s(["#faa"],20)},f={health:10,speed:40,damage:1,R:1,N:3,size:10,J:r(["#999"],5)},P={health:20,speed:40,damage:1,R:1,N:4,size:10,J:r(["#999","#0ac"],5)},I={health:50,speed:40,damage:1,R:1,N:5,size:10,J:r(["#999","#0ac","#4ca"],5)},r={health:1e3,speed:40,damage:5,R:1,N:4,Z:!0,ee:80,size:16,J:r(["#faa"],8)};let ie=(t,e,r=1)=>Array.from({length:H((e-t)/r)}).map((e,a)=>a*r+t);var oe,ce=t=>()=>{var e=ie(F.x-N,F.x+N,2*t.size),a=ie(F.y-U,F.y+U,2*t.size);e.map(e=>d(e,F.y-U,t)),e.map(e=>d(e,F.y+U,t)),a.map(e=>d(F.x-N,e,t)),a.map(e=>d(F.x+N,e,t))};let le=[{from:0,types:[a],rate:.4},{from:30,types:[a,e],rate:.4},{from:80,types:[a,e],rate:.1},{from:120,types:[e],rate:.2,Z:{health:500,speed:30,damage:10,R:1,N:20,size:20,J:(e,a,t)=>o(["#faa"],20),Z:!0}},{from:150,types:[e,f],rate:.3},{from:200,types:[e,f],rate:.15},{from:250,types:[t],rate:.2,ae:ce(t)},{from:300,types:[t,B,f],rate:.2},{from:330,types:[B,f],Z:s,rate:.2},{from:380,types:[B,P,t],rate:.15},{from:450,types:[P,n],rate:.15,ae:(oe=P,()=>{var e=G/40;ie(0,G,e).map(e=>{var a=F.x+W(e)*N,e=F.y+$(e)*U;d(a,e,oe)})})},{from:500,types:[n,p],rate:.1},{from:550,types:[n,p],rate:.1},{from:600,types:[n,p,I],rate:.1},{from:650,types:[n,p],Z:r,rate:.15},{from:700,types:[n,p,I],rate:.1,ae:ce(p)},{from:720,types:[],rate:0,Z:{health:1e4,speed:55,damage:5,R:1,N:0,Z:!0,ee:1e3,size:50,J:(e,a,t)=>{k.l(e,a,25,t??"#faa"),k.i(e,a,25,t??"#0ac"),k.o(e,a,23,t??"#faa")}}}],pe=(e,a,t)=>({x:e,y:a,type:t,health:t.health,R:0,te:0,re:0,se:0,Z:!!t.Z}),d=(e,a,t)=>J.push(pe(e,a,t)),J=[],fe={ne:0,ie:1},Q=[];function de(e,a,t){var r,s=[["Base damage",l(F.D.damage.value)],["Attack speed",l(F.D.attackSpeed.value,2)],["Health",H(F.D.health.value)],["Regeneration",l(F.D.healthRegen.value,2)+"/s"],["Speed",l(F.D.speed.value,2)],["Health Drop",l(100*F.D.healthDrop.value)+"%"]];for(r of F.T){var n=r.type.name;switch(r.type.type){case q.h:var i=r.type.v[r.level];s.push([n+" level",r.level+1]),s.push([n+" damage",l(i.damage)]),s.push([n+" range",l(i.range)]),s.push([n+" angle",T(i.angle)+"°"]);break;case q.m:i=r.type.v[r.level];s.push([n+" level",r.level+1]),s.push([n+" damage",l(i.damage)]),s.push([n+" range",l(i.range)]),s.push([n+" blades",l(i.blades)]),s.push([n+" size",l(i.size)]);break;case q.g:var o=r.type.v[r.level];s.push([n+" level",r.level+1]),s.push([n+" damage",l(o.damage)]),s.push([n+" range",l(o.range)])}}E(e,a,t,c-a-20,s)}function me(e,a,t){var r;for(r of[["Survived for",R(j.runtime)],["Level",""+(F.level+1)],["Damage done",l(j.q)],["DPS",""+l(j.q/j.runtime,2)],["Kills",""+j.F]])k.text(e+t/2-5,a,r[0],"#ccc","right"),k.text(e+t/2+5,a,r[1],"#fff","left"),a+=15;return a}function he(){if(j.state!==_.V&&(k.rect(50,0,L-50,20,"#600"),k.rect(50,0,F.health/F.D.health.value*(L-50),20,"#f66"),k.text(52,10,H(F.health)+" / "+H(F.D.health.value),"#fff","left","middle"),k.rect(50,20,L-50,12,"#999"),k.rect(50,20,F.N/F.U*(L-50),12,"#fff"),k.text(52,27,F.N+" / "+F.U,"#000","left","middle"),k.rect(0,0,50,32,"#000"),k.text(25,2,"level","#666","center","top"),k.text(25,18,""+(F.level+1),"#fff","center","top"),k.text(N,35,R(j.runtime),"#fff","center"),j.runtime<20)){let e=c-30-15*h.length;for(var a of h)k.text(10,e,a,"#fff","left","top"),e+=15}switch(j.state){case _.K:k.t(),k.text(N,100,"YOU'RE DEAD!","#f88","center","top",24),e=me(50,145,L-100),e+=30,k.text(N,e,x,"#fff","center");break;case _.Y:k.t(),k.text(N,10,"LEVEL UP","#fff","center","top");for(let e=0;e<j.O.length;e++){let a=j.O[e];var t=F.O.filter(e=>e===a).length,r=50+50*e;y.textAlign="left",y.textBaseline="top",y.fillStyle=e===j.j?"#333":"#222",y.fillRect(20,r,L-40,40),y.strokeStyle=e===j.j?"#aa3":"#444",y.strokeRect(20,r,L-40,40),y.fillStyle="#fff",y.fillText(a.name,25,5+r),y.fillStyle="#ccc",y.fillText("function"==typeof a.description?a.description():a.description,25,22+r),k.text(20+L-50,20+r,t+"/"+a.B,"#ccc","right","middle")}de(20,210,L-40);break;case _.G:k.t(),k.text(N,100,"PAUSED","#fff","center","middle"),de(20,110,L-40);break;case _.WIN:k.t(),k.text(N,100,"YOU WON","#fff","center","middle");var e=me(100,130,L-200);e+=30,k.text(N,e,x,"#fff","center");break;case _.V:k.t(),k.text(N,U-40,"MICRO","#fff","center","bottom",68),k.text(N,U-40,"SURVIVORS","#fff","center","top",38),k.text(N,c-5,"by Kamen","#ccc","center","bottom",10),y.globalAlpha=.5+.5*(.5*W(performance.now()/1e3*5)+.5),k.text(N,U+50,v,"#fff","center"),y.globalAlpha=1}}function ge(){y.reset(),y.clearRect(0,0,b.width,b.height),y.translate(-F.x+N,-F.y+U);var e,a,t,r=50*H((F.x-N)/50),s=50*H((F.y-U)/50),n=50*w((F.x+N)/50),i=50*w((F.y+U)/50);for(let a=r;a<n;a+=50)for(let e=s;e<i;e+=50)k.rect(a,e,50,50,a%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000");for(e of Q)k.i(e.x-3,e.y-3,10<=(e.N??0)?8:6,0<(e.health??0)?"#0c0":(e.N??0)<10?"#05f":"#ff0");for(a of F.T)switch(a.type.type){case q.m:var o=a.type.v[a.level],c=G/o.blades,l=a.S*o.rotationSpeed;for(let e=0;e<o.blades;e++){var p=l+c*e,f=F.x+W(p)*o.range,p=F.y+$(p)*o.range;k.l(f,p,o.size/2,"#fff")}break;case q.h:var d=a.type.v[a.level],m=d.k*F.D.attackSpeed.value,m=.2*(a.R/m);0<m&&(h=d.angle/2,y.fillStyle=`rgba(255,255,255,${m})`,y.beginPath(),y.moveTo(F.x,F.y),y.lineTo(F.x+W(F.$-h)*d.range,F.y+$(F.$-h)*d.range),y.arc(F.x,F.y,d.range,F.$-h,F.$+h),y.lineTo(F.x,F.y),y.fill());break;case q.g:var m=a.type.v[a.level],d=m.k*F.D.attackSpeed.value,h=a.R/d,g=.15+.02*W(2*h*u);k.l(F.x,F.y,m.range,`rgba(255,0,0,${g})`)}k.rect(F.x-5,F.y-5,10,10,"#fff");for(t of J){var v=t.type;v.J(t.x,t.y,0<t.se?"#fff":void 0),v.Z&&(k.rect(t.x-20,t.y+15,40,3,"#333"),k.rect(t.x-20,t.y+15,t.health/v.health*40,3,"#f33"))}y.resetTransform(),0<(r=O(1,F.M/.5))&&(r=D(80,"rgba(255,0,0,0)",`rgba(255,0,0,${r})`),k.t(r)),0<(r=O(1,F.W/.1))&&(r=D(130,"rgba(255,255,255,0)",`rgba(255,255,255,${.15*r})`),k.t(r)),he()}function ve(s){var e,a,t,r=s;switch(j.state){case _.RUNNING:(j.runtime+=r,X.pause)?j.state=_.G:F.health<=0?j.state=_.K:(a=le.findIndex(e=>e.from>j.runtime)-1,e=le[a<0?le.length-1:a],-2==a&&0===J.length&&(j.state=_.WIN),e&&(a!==j.X&&(j.X=a,e.Z&&ue(e.Z),e.ae)&&e.ae(),j._>e.rate?(0<e.types.length&&ue(ae(e.types)),j._=0):j._+=r));break;case _.WIN:case _.K:case _.V:V.enter&&(()=>{for(var e in F=se(te),ne)j[e]=ne[e];j.state=_.RUNNING,J.length=0,Q.length=0})();break;case _.Y:X.up&&0<j.j&&j.j--,X.down&&j.j<j.O.length-1&&j.j++,X.enter&&((a=j.O[j.j]).apply(F),F.O.push(a),j.state=_.RUNNING);break;case _.G:(X.pause||X.enter)&&(j.state=_.RUNNING)}if(j.state===_.RUNNING){{var n,i=s;let t=0,r=[];for(n of J){var o=n.type;if(n.health<=0)Q.push({x:n.x,y:n.y,type:fe.ie,N:o.N}),M()<F.D.healthDrop.value&&Q.push({x:n.x-5+10*M(),y:n.y-5+10*M(),type:fe.ne,health:10}),j.F+=1,r.push(t);else{0<n.se&&(n.se-=i);let e=n.te*i,a=n.re*i;var c,l=F.x-n.x,p=F.y-n.y,f=K(l,p);!n.Z&&3*L<f?r.push(t):(n.R<=0?(f<n.type.size-2&&(F.health-=o.health,F.M=.5,n.R=o.R),c=o.speed*i,e+=l/f*c,a+=p/f*c):n.R-=i,n.x+=e,n.y+=a,!(.1<Y(n.te))||(l=(0<n.te?-1:1)*i*(o.ee??20),Y(l)>Y(n.te))?n.te=0:n.te+=l,!(.1<Y(n.re))||(p=(0<n.re?-1:1)*i*(o.ee??20),Y(p)>Y(n.re))?n.re=0:n.re+=p)}t++}let a=0;for(let e of r)J.splice(e-a,1),a+=1}{var d,m=s;let e=0,a=[];for(d of Q){var h,g=F.x-d.x,v=F.y-d.y,u=K(g,v);if(u<10){switch(d.type){case fe.ne:F.health=O(F.D.health.value,F.health+(d.health??0));break;case fe.ie:F.N+=d.N??0}F.W=.1,a.push(e)}else u<F.D.pickupDistance.value&&(h=(F.D.pickupDistance.value+10-u)*m*2,d.x+=g/u*h,d.y+=v/u*h);e++}let t=0;for(let e of a)Q.splice(e-t,1),t+=1}{var k=s;let e=0,a=0;V.up&&--a,V.down&&(a+=1),V.left&&--e,V.right&&(e+=1);var b,s=F.D.speed.value*k,y=K(e,a);0<y&&(F.x+=e/y*s,F.y+=a/y*s),y=N,s=U,F.$=Z(V.targetY-s,V.targetX-y),F.N>=F.U&&(F.level+=1,F.N-=F.U,F.U+=10,s=re.filter(a=>!(a.P&&!a.P(F)||a.B&&F.O.filter(e=>e===a).length>=a.B)),j.O=(a=>{for(let e=a.length-1;0<=e;e--){var t=H(M()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a})(s).slice(0,3),0<j.O.length&&(j.state=_.Y),F.health+=5),0<F.M&&(F.M-=k),0<F.W&&(F.W-=k),F.health=O(F.D.health.value,F.health+F.D.healthRegen.value*k);for(b of F.T)switch(b.S+=k,b.type.type){case q.m:var w=b.type.v[b.level],x=w.damage+F.D.damage.value;if(b.R<=0){b.R=w.u*F.D.attackSpeed.value;var S=G/w.blades,R=b.S*w.rotationSpeed;for(let e=0;e<w.blades;e++){var T,E=R+S*e,D=F.x+W(E)*w.range,A=F.y+$(E)*w.range;for(T of J)ee(T.x,T.y,D,A)<w.size/2+T.type.size+2&&(T.health-=x,T.se=.1,T.te=20*W(E),T.re=20*$(E),j.q+=x)}}else b.R-=k;break;case q.h:0<b.R?b.R-=k:(((e,a)=>{var t,r=a.v[e.level],s=r.damage+F.D.damage.value,a=r.angle/2,n=F.$-a,i=F.$+a;for(t of J){var o=t.x-F.x,c=t.y-F.y,l=Z(c,o),o=K(o,c),c=Z(t.type.size/2,o);n<l+c&&l-c<i&&o-t.type.size/2<r.range&&(t.health-=s,t.se=.1,t.te=25*W(l),t.re=25*$(l),j.q+=s)}})(b,b.type),b.R=b.type.v[b.level].k*F.D.attackSpeed.value);break;case q.g:if(0<b.R)b.R-=k;else{var z,C=b.type.v[b.level],B=C.damage+F.D.damage.value;for(z of J){var P=z.x-F.x,I=z.y-F.y;let e=K(P,I);e<C.range&&(z.health-=B,z.se=.1,j.q+=B)}b.R=b.type.v[b.level].k*F.D.attackSpeed.value}}}}for(t in X)X[t]=!1}function ue(e){var a=M()*G,t=Math.max(L,c)/2,t=K(t,t)+15*M();J.push(pe(F.x+W(a)*t,F.y+$(a)*t,e))}let ke=0;return m.appendChild(b),requestAnimationFrame(function e(a){requestAnimationFrame(e);var t=(a-ke)/1e3;ke=a,ge(),ve(t)}),[F,j]}