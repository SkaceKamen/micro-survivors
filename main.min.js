function microSurvivors(O=document.body,i=400,n=400){let L=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],p=i/2,f=n/2,{floor:o,ceil:$,random:c,round:M,cos:l,sin:m,min:K,hypot:h,abs:g,atan2:W,PI:t}=Math,d=2*t;var e="Press ENTER to ";let Y=e+"start",G=e+"restart",s="center",v="top",u="left",y="right",H="middle";e="addEventListener";let V=(e,a=2,r="0")=>e.toString().padStart(a,r),j=e=>V(o(e/60))+":"+V(o(e%60));let q=e=>b(e*(180/t))+"Â°",b=(e,a=0)=>e.toFixed(a),F=(e,a,r,t)=>h(r-e,t-a),X=a=>{for(let e=a.length-1;0<=e;e--){var r=o(c()*(e+1));[a[e],a[r]]=[a[r],a[e]]}return a},_=e=>e[M(c()*(e.length-1))],k={rect(e,a,r,t,s,n){x[n?"strokeStyle":"fillStyle"]=s,x[n?"strokeRect":"fillRect"](e,a,r,t)},t(e="#000000e5"){x.fillStyle=e,x.fillRect(0,0,i,n)},o(e,a,r,t){x.fillStyle=t,x.fillRect(e-r/2,a-r/2,r,r)},l(e,a,r,t){x.fillStyle=t,x.beginPath(),x.moveTo(e,a-r/2),x.lineTo(e-r/2,a+r/2),x.lineTo(e+r/2,a+r/2),x.fill()},text(e,a,r,t,s=u,n=v,o=14){x.font=o+"px monospace",x.fillStyle=t,x.textAlign=s,x.textBaseline=n,x.fillText(r,e,a)},i(e,a,r,t){x.fillStyle=t,x.beginPath(),x.arc(e,a,r,0,d),x.fill()}},J=(e,a,r,t,s)=>{var n,o,p=a,f=r/2;15*(s.length-1)<=t&&(e+=r/4);for([n,o]of s)k.text(e,a,n+":","#aaa"),k.text(e+f-5,a,""+o,"#fff",y),p+t<(a+=15)&&(a=p,e+=f)},Q=(e,a,r)=>{e=x.createRadialGradient(p,f,e,p,f,p);return e.addColorStop(0,a),e.addColorStop(1,r),e},r=document.createElement("canvas"),x=(r.width=i,r.height=n,r.getContext("2d")??(()=>{throw new Error})()),Z={arrowup:"up",arrowdown:"down",arrowleft:u,arrowright:y,w:"up",s:"down",a:u,d:y,enter:"enter",escape:"pause",p:"pause"},w={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},R={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},ee=(e,a)=>{e=Z[e.key.toLowerCase()];e&&(w[e]=a,R[e]=a)};document[e]("keydown",e=>ee(e,!0)),document[e]("keyup",e=>ee(e,!1)),r[e]("mousemove",e=>{var a=r.getBoundingClientRect();w.targetX=e.clientX-a.left,w.targetY=e.clientY-a.top});var e=e=>{let r=e[0],t=[e[0]];return e.forEach((e,a)=>{r={...r,...e},t[a]=r}),t},a={name:"Saw Blades",m:e([{damage:5,range:50,rotationSpeed:t/2,h:.1,blades:1,size:10},{blades:2},{damage:10,rotationSpeed:t/1.5},{rotationSpeed:t/1.25,size:15},{blades:3},{damage:15},{blades:4}]),g(e,a){var r=a.damage+T.v.damage.value,t=d/a.blades,s=e.g*a.rotationSpeed;for(let e=0;e<a.blades;e++){var n,o=s+t*e,p=T.x+l(o)*a.range,f=T.y+m(o)*a.range;for(n of I)F(n.x,n.y,p,f)<a.size/2+n.type.size+2&&(n.health-=r,n.u=.1,n.k=20*l(o),n.R=20*m(o),U.S+=r)}},D(e,a){var r=d/a.blades,t=e.g*a.rotationSpeed;for(let e=0;e<a.blades;e++){var s=t+r*e,n=T.x+l(s)*a.range,s=T.y+m(s)*a.range;k.i(n,s,a.size/2,"#fff")}},A:(e,a)=>[["damage",b(a.damage)],["range",b(a.range)],["speed",q(a.rotationSpeed)+"/s"],["blades",b(a.blades)],["size",b(a.size)]]},S={name:"Sword",m:e([{damage:8,angle:t/4,range:80,h:.5},{damage:13},{angle:t/4*1.2,range:90},{damage:18},{damage:23},{damage:28,angle:t/4*1.5},{damage:33,angle:t/4*1.7,range:120}]),g(e,a){var r,t=a.damage+T.v.damage.value,s=a.angle/2,n=T.C-s,o=T.C+s;for(r of I){var p=r.x-T.x,f=r.y-T.y,d=W(f,p),p=h(p,f),f=W(r.type.size/2,p);n<d+f&&d-f<o&&p-r.type.size/2<a.range&&(r.health-=t,r.u=.1,r.k=25*l(d),r.R=25*m(d),U.S+=t)}},D(e,a){var r=a.h*T.v.attackSpeed.value,e=.2*(e.T/r);0<e&&(r=a.angle/2,x.fillStyle=`rgba(255,255,255,${e})`,x.beginPath(),x.moveTo(T.x,T.y),x.lineTo(T.x+l(T.C-r)*a.range,T.y+m(T.C-r)*a.range),x.arc(T.x,T.y,a.range,T.C-r,T.C+r),x.lineTo(T.x,T.y),x.fill())},A:(e,a)=>[["damage",b(a.damage)],["range",b(a.range)],["angle",q(a.angle)]]},e={name:"Barbed Wire",m:e([{range:40,damage:2,h:.75},{range:60},{damage:3},{range:70},{range:80},{damage:4}]),g(e,a){var r,t=a.damage+T.v.damage.value;for(r of I)F(T.x,T.y,r.x,r.y)<a.range&&(r.health-=t,r.u=.1,U.S+=t)},D(e,a){var r=a.h*T.v.attackSpeed.value,e=e.T/r,r=.15+.02*l(2*e*t);k.i(T.x,T.y,a.range,`rgba(255,0,0,${r})`)},A:(e,a)=>[["damage",b(a.damage)],["range",b(a.range)]]};let ae=e=>({type:e,g:0,T:0,level:0});var D=e=>()=>T.level*e;let re={P:[S],v:{health:[50,D(5)],speed:[45,D(.2)],healthRegen:[.1,D(.025)],pickupDistance:[50],damage:[D(.3)],attackSpeed:[1],healthDrop:[.01]}};var D=(e,a)=>()=>T.v[e].base.push(a),A=(e,a)=>()=>T.v[e].base.push(a),E=p=>{let f;return{name:p.name,description(){var e=f?.U??T.P.find(e=>e.type===p);if(!e)return"New weapon";if(f?.level===e.level)return f.B;var a,r,t=e.type.m[e.level],s=e.type.m[e.level+1],n=[];for(a in s)s[a]!==t[a]&&(r=s[a]-t[a],r=("angle"===a?q:b)(r),n.push(`+${r} `+a));var o=n.join(", ");return f={level:e.level,U:e,B:o},o},apply(){var e=T.P.find(e=>e.type===p);e?e.level++:T.P.push(ae(p))},I:p.m.length-1}};let te=[{name:"Speed boost",description:"+25% speed",apply:A("speed",1.25),I:5},{name:"Speed base",description:"+1 base speed",apply:D("speed",1),I:5},{name:"Max health",description:"+25 max health, +5 health",apply:()=>{T.v.health.base.push(25),T.health+=5},I:5},{name:"Health drop",description:"+1% health drop chance",apply:D("healthDrop",.01),I:5},{name:"Regen",description:"+0.1/s health regen",apply:D("healthRegen",.1),I:5},{name:"Regen boost",description:"+10% health regen",apply:A("healthRegen",1.1),I:5},{name:"Pickup range",description:"+10 pickup range",apply:D("pickupDistance",10),I:5},{name:"Damage",description:"+1 damage",apply:D("damage",1),I:5},{name:"Attack speed",description:"+5% attack speed",apply:D("attackSpeed",-.05),I:5},E(a),E(S),E(e)],se=e=>"function"==typeof e?e():e,C=(e=[],a=[])=>({base:[...e],multiplier:[...a],N:null,get value(){var e;return this.N?.base===this.base&&this.N?.multiplier===this.multiplier&&this.N?.O===T.level?this.N.value:(e=this.base.reduce(e=(e,a)=>e+se(a),0)*this.multiplier.reduce(e,1),this.N={base:this.base,multiplier:this.multiplier,O:T.level,value:e},e)}}),ne=e=>({type:e,x:0,y:0,level:0,L:0,$:5,health:100,M:0,K:0,W:0,C:0,v:{speed:C(e.v.speed),health:C(e.v.health),healthRegen:C(e.v.healthRegen),pickupDistance:C(e.v.pickupDistance),damage:C(e.v.damage),attackSpeed:C(e.v.attackSpeed),healthDrop:C(e.v.healthDrop)},Y:[],P:e.P.map(e=>ae(e))}),T=ne(re),P={RUNNING:0,G:1,H:2,V:3,WIN:4,j:5},oe={q:-1,runtime:0,S:0,F:0,X:0,Y:[],_:0},U={state:P.j,...oe};var A=e=>({...e,T:1,size:10}),D=(e,n)=>(r,t,s)=>e.map((e,a)=>k.o(r+a,t+a,n,s??e)),a=(e,n)=>(r,t,s)=>e.map((e,a)=>k.l(r+a,t+a,n,s??e)),S=(e,n)=>(r,t,s)=>e.map((e,a)=>k.i(r+a,t+a,n,s??e)),E=A({health:10,speed:26,damage:8,L:1,D:D(["#aaa"],10)}),e=A({health:50,speed:26,damage:10,L:2,D:D(["#aaa","#faa"],10)}),z=A({health:100,speed:30,damage:20,L:3,D:D(["#aaa","#faa","#4a4"],10)}),D=A({health:1e3,speed:30,damage:20,L:20,size:20,D:D(["#faa"],20),J:!0}),pe=A({health:20,speed:35,damage:10,L:2,D:a(["#999"],10)}),fe=A({health:40,speed:35,damage:20,L:3,D:a(["#999","#0ac"],10)}),B=A({health:60,speed:35,damage:30,L:4,D:a(["#999","#0ac","#966"],10)}),a=A({health:3e3,speed:35,damage:30,L:50,J:!0,Z:80,size:20,D:a(["#faa"],20)}),de=A({health:10,speed:40,damage:8,L:3,D:S(["#999"],5)}),le=A({health:20,speed:40,damage:10,L:4,D:S(["#999","#0ac"],5)}),ie=A({health:50,speed:40,damage:20,L:5,D:S(["#999","#0ac","#4ca"],5)}),S=A({health:5e3,speed:40,damage:20,L:4,J:!0,Z:80,size:16,D:S(["#faa"],8)}),A=A({health:12e3,speed:55,damage:50,L:0,J:!0,Z:1e3,size:50,D(e,a,r){k.i(e,a,25,r??"#faa"),k.o(e,a,25,r??"#0ac"),k.l(e,a,23,r??"#faa")}});let ce=(r,e,t=1)=>Array.from({length:o((e-r)/t)}).map((e,a)=>a*t+r);var me,he=r=>()=>{var e=ce(T.x-p,T.x+p,2*r.size),a=ce(T.y-f,T.y+f,2*r.size);e.map(e=>ue(e,T.y-f,r)),e.map(e=>ue(e,T.y+f,r)),a.map(e=>ue(T.x-p,e,r)),a.map(e=>ue(T.x+p,e,r))};let ge=[{from:0,types:[E],rate:.4},{from:30,types:[E,pe],rate:.5},{from:80,types:[E,pe],rate:.4},{from:120,types:[pe],rate:.3,J:D},{from:150,types:[pe,de],rate:.4},{from:200,types:[pe,de],rate:.3},{from:250,types:[e],rate:.3,ee:he(e)},{from:300,types:[e,fe,de],rate:.3},{from:330,types:[fe,de],J:a,rate:.3},{from:380,types:[fe,le,e],rate:.3},{from:450,types:[le,z],rate:.4,ee:(me=le,()=>{var e=d/40;ce(0,d,e).map(e=>{var a=T.x+l(e)*p,e=T.y+m(e)*f;ue(a,e,me)})})},{from:500,types:[z,B],rate:.3},{from:550,types:[z,B],rate:.25},{from:600,types:[z,B,ie],rate:.25},{from:650,types:[z,B],J:S,rate:.4},{from:700,types:[z,B,ie],rate:.25,ee:he(B)},{from:720,types:[],rate:0,J:A}],ve=(e,a,r)=>({x:e,y:a,type:r,health:r.health,T:0,k:0,R:0,u:0,J:!!r.J}),ue=(e,a,r)=>I.push(ve(e,a,r)),I=[],N=[],ye=()=>{var e=50*o((T.x-p)/50),r=50*o((T.y-f)/50),t=50*$((T.x+p)/50),s=50*$((T.y+f)/50);for(let a=e;a<t;a+=50)for(let e=r;e<s;e+=50)k.rect(a,e,50,50,a%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000")},be=()=>{for(var e of T.P)e.type.D(e,e.type.m[e.level]);k.rect(T.x-5,T.y-5,10,10,"#fff")},ke=()=>{for(var e of I){var a=e.type;a.D(e.x,e.y,0<e.u?"#fff":void 0),a.J&&(k.rect(e.x-20,e.y+15,40,3,"#333"),k.rect(e.x-20,e.y+15,e.health/a.health*40,3,"#f33"))}},xe=()=>{for(var e of N)k.o(e.x-3,e.y-3,10<=(e.L??0)?8:6,0<(e.health??0)?"#0c0":(e.L??0)<10?"#05f":"#ff0")},we=(e,a,r)=>{var t,s=[["Base damage",b(T.v.damage.value)],["Attack speed",b(T.v.attackSpeed.value,2)],["Health",o(T.v.health.value)],["Regeneration",b(T.v.healthRegen.value,2)+"/s"],["Speed",b(T.v.speed.value,2)],["Health Drop",b(100*T.v.healthDrop.value)+"%"]];for(t of T.P){let r=t.type.name;s.push([r+" level",t.level+1],...t.type.A(t,t.type.m[t.level]).map(([e,a])=>[r+" "+e,a]))}J(e,a,r,n-a-40,s)},Re=(e,a,r)=>{var t;for(t of[["Survived",j(U.runtime)],["Level",""+(T.level+1)],["Damage",b(U.S)],["DPS",""+b(U.S/U.runtime,2)],["Kills",""+U.F]])k.text(e+r/2-5,a,t[0],"#ccc",y),k.text(e+r/2+5,a,t[1],"#fff",u),a+=15;return a},Se=()=>{if(k.rect(50,0,i-50,20,"#600"),k.rect(50,0,T.health/T.v.health.value*(i-50),20,"#f66"),k.text(52,10,o(T.health)+"/"+o(T.v.health.value),"#fff",u,H),k.rect(50,20,i-50,12,"#999"),k.rect(50,20,T.L/T.$*(i-50),12,"#fff"),k.text(52,27,T.L+"/"+T.$,"#000",u,H),k.rect(0,0,50,32,"#000"),k.text(25,2,"level","#666",s,v),k.text(25,18,""+(T.level+1),"#fff",s,v),k.text(p,35,j(U.runtime),"#fff",s),U.runtime<20){let e=n-30-15*L.length;for(var a of L)k.text(10,e,a,"#fff",u,v),e+=15}},De=()=>{switch(U.state!==P.j&&Se(),U.state){case P.G:k.t(),k.text(p,100,"YOU'RE DEAD!","#f88",s,v,24),e=Re(50,145,i-100),e+=30,k.text(p,e,G,"#fff",s);break;case P.H:k.t(),k.text(p,10,"LEVEL UP","#fff",s,v);for(let e=0;e<U.Y.length;e++){let a=U.Y[e];var r=T.Y.filter(e=>e===a).length,t=50+50*e;k.rect(20,t,i-40,40,e===U._?"#333":"#222"),k.rect(20,t,i-40,40,e===U._?"#aa3":"#444",!0),k.text(25,5+t,a.name,"#fff"),k.text(25,22+t,"function"==typeof a.description?a.description():a.description,"#ccc"),k.text(20+i-50,20+t,r+"/"+a.I,"#ccc",y,H)}we(20,210,i-40);break;case P.V:k.t(),k.text(p,40,"PAUSED","#fff",s,H),we(20,80,i-40);break;case P.WIN:k.t(),k.text(p,100,"YOU WON","#fff",s,H);var e=Re(100,130,i-200);e+=30,k.text(p,e,G,"#fff",s);break;case P.j:k.t(),k.text(p,f-40,"MICRO","#fff",s,"bottom",68),k.text(p,f-40,"SURVIVORS","#fff",s,v,38),k.text(p,n-5,"by Kamen","#ccc",s,"bottom",10),x.globalAlpha=.5+.5*(.5*l(performance.now()/1e3*5)+.5),k.text(p,f+50,Y,"#fff",s),x.globalAlpha=1}},Ae=()=>{var e=K(1,T.K/.5),e=(0<e&&(e=Q(80,"#ff000000",`rgba(255,0,0,${e})`),k.t(e)),K(1,T.W/.1));0<e&&(e=Q(130,"#ffffff00",`rgba(255,255,255,${.15*e})`),k.t(e))},Ee=r=>{let t=0;var s,n=[];for(s of I){var o=s.type;if(s.health<=0)N.push({x:s.x,y:s.y,L:o.L}),c()<T.v.healthDrop.value&&N.push({x:s.x-5+10*c(),y:s.y-5+10*c(),health:10}),U.F+=1,n.push(t);else{0<s.u&&(s.u-=r);let e=s.k*r,a=s.R*r;var p,f=T.x-s.x,d=T.y-s.y,l=h(f,d);!s.J&&3*i<l?n.push(t):(s.T<=0?(l<s.type.size-2&&(T.health-=o.damage,T.K=.5,s.T=o.T),p=o.speed*r,e+=f/l*p,a+=d/l*p):s.T-=r,s.x+=e,s.y+=a,!(.1<g(s.k))||(f=(0<s.k?-1:1)*r*(o.Z??20),g(f)>g(s.k))?s.k=0:s.k+=f,!(.1<g(s.R))||(d=(0<s.R?-1:1)*r*(o.Z??20),g(d)>g(s.R))?s.R=0:s.R+=d)}t++}let a=0;for(let e of n)I.splice(e-a,1),a+=1},Ce=e=>{var a=c()*d,r=Math.max(i,n)/2,r=h(r,r)+15*c();I.push(ve(T.x+l(a)*r,T.y+m(a)*r,e))},Te=()=>{Object.assign(T,ne(re)),Object.assign(U,oe),U.state=P.RUNNING,I.length=0,N.length=0},Pe=e=>{switch(U.state){case P.RUNNING:U.runtime+=e,R.pause&&(U.state=P.V),T.health<=0&&(U.state=P.G);var a=ge.findIndex(e=>e.from>U.runtime)-1,r=ge[a<0?ge.length-1:a];-2==a&&0===I.length&&(U.state=P.WIN),r&&(a!==U.q&&(U.q=a,r.J&&Ce(r.J),r.ee?.()),U.X>r.rate?(0<r.types.length&&Ce(_(r.types)),U.X=0):U.X+=e);break;case P.WIN:case P.G:case P.j:w.enter&&Te();break;case P.H:R.up&&0<U._&&U._--,R.down&&U._<U.Y.length-1&&U._++,R.enter&&((a=U.Y[U._]).apply(),T.Y.push(a),U.state=P.RUNNING);break;case P.V:(R.pause||R.enter)&&(U.state=P.RUNNING)}},Ue=()=>{for(var e in R)R[e]=!1},ze=e=>{let a=0,r=0;w.up&&--r,w.down&&(r+=1),w.left&&--a,w.right&&(a+=1);var t,s,n=T.v.speed.value*e,o=h(a,r),o=(0<o&&(T.x+=a/o*n,T.y+=r/o*n),p),n=f;T.C=W(w.targetY-n,w.targetX-o),T.L>=T.$&&(T.level+=1,T.L-=T.$,T.$+=10,n=te.filter(a=>!(a.condition&&!a.condition()||a.I&&T.Y.filter(e=>e===a).length>=a.I)),U.Y=X(n).slice(0,3),0<U.Y.length&&(U.state=P.H),T.health+=5),0<T.K&&(T.K-=e),0<T.W&&(T.W-=e),T.health=K(T.v.health.value,T.health+T.v.healthRegen.value*e);for(t of T.P)t.g+=e,t.T<=0?(s=t.type.m[t.level],t.type.g(t,s),t.T=s.h*T.v.attackSpeed.value):t.T-=e},Be=e=>{let a=0;var r,t=[];for(r of N){var s,n=T.x-r.x,o=T.y-r.y,p=h(n,o);p<10?(T.health=K(T.v.health.value,T.health+(r.health??0)),T.L+=r.L??0,T.W=.1,t.push(a)):p<T.v.pickupDistance.value&&(s=(T.v.pickupDistance.value+10-p)*e*2,r.x+=n/p*s,r.y+=o/p*s),a++}let f=0;for(let e of t)N.splice(e-f,1),f+=1},Ie=0,Ne=e=>{requestAnimationFrame(Ne);var a=(e-Ie)/1e3;Ie=e,x.reset(),x.clearRect(0,0,i,n),x.translate(-T.x+p,-T.y+f),ye(),xe(),be(),ke(),x.resetTransform(),Ae(),De(),e=a,Pe(e),U.state===P.RUNNING&&(Ee(e),Be(e),ze(e)),Ue()};return O.appendChild(r),requestAnimationFrame(Ne),[T,U]}