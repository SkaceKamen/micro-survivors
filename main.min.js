function microSurvivors(M=document.body,p=400,d=400){let $=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],m=p/2,i=d/2,{floor:o,ceil:G,random:c,round:K,cos:l,sin:h,min:W,hypot:u,abs:f,atan2:Y,PI:t}=Math,g=2*t;var e="Press ENTER to ";let C=e+"start",H=e+"restart",s="center",v="top",R="left",V="right",j="middle";e="addEventListener";let w="#fff",q="#aaa",F="#ccc",n="#faa",X="#0ac",r="#999",z=(e,a=2,r="0")=>e.toString().padStart(a,r),_=e=>z(o(e/60))+":"+z(o(e%60)),J=e=>b(e*(180/t))+"Â°",b=(e,a=0)=>e.toFixed(a),Q=(e,a,r,t)=>u(r-e,t-a),Z=a=>{for(let e=a.length-1;0<=e;e--){var r=(r=>{var e=r.map(e=>e.weight).reduce((e,a)=>e+a),t=c()*e;for(let e=0,a=0;;e++)if(a+=r[e].weight,t<=a)return e})(a.slice(e));[a[e],a[r]]=[a[r],a[e]]}return a.map(e=>e.A)};let ee=e=>e[K(c()*(e.length-1))],k=e=>D.fillStyle=e,x={rect(e,a,r,t,s,n){D[n?"strokeStyle":"fillStyle"]=s,D[n?"strokeRect":"fillRect"](e,a,r,t)},t(e="#000000e5"){k(e),D.fillRect(0,0,p,d)},o(e,a,r,t){k(t),D.fillRect(e-r/2,a-r/2,r,r)},m(e,a,r,t){k(t),D.beginPath(),D.moveTo(e,a-r/2),D.lineTo(e-r/2,a+r/2),D.lineTo(e+r/2,a+r/2),D.fill()},text(e,a,r,t,s=R,n=v,d=14){D.font=d+"px monospace",k(t),D.textAlign=s,D.textBaseline=n,D.fillText(r,e,a)},i(e,a,r,t){k(t),D.beginPath(),D.arc(e,a,r,0,g),D.fill()},Se(e){D.globalAlpha=e}},ae=(e,a,r,t,s)=>{var n,d,m=a,i=r/2;15*(s.length-1)<=t&&(e+=r/4);for([n,d]of s)x.text(e,a,n+":",q),x.text(e+i-5,a,""+d,w,V),m+t<(a+=15)&&(a=m,e+=i)},re=(e,a,r)=>{e=D.createRadialGradient(m,i,e,m,i,m);return e.addColorStop(0,a),e.addColorStop(1,r),e},S=document.createElement("canvas"),D=(S.width=p,S.height=d,S.getContext("2d")),te={arrowup:"up",arrowdown:"down",arrowleft:R,arrowright:V,w:"up",s:"down",a:R,d:V,enter:"enter",escape:"pause",p:"pause"},A={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},y={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},se=(e,a)=>{e=te[e.key.toLowerCase()];e&&(A[e]=a,y[e]=a)};var a=document[e],a=(a("keydown",e=>se(e,!0)),a("keyup",e=>se(e,!1)),S[e]("mousemove",e=>{var a=S.getBoundingClientRect();A.targetX=e.clientX-a.left,A.targetY=e.clientY-a.top}),e=>{let r=e[0],t=[e[0]];return e.forEach((e,a)=>{r={...r,...e},t[a]=r}),t}),e={l:"Saw Blades",q:"spinning blades",u:a([{h:10,g:50,v:t/1.5,R:.1,k:1,S:10},{k:2},{h:15,v:t/1.25},{v:+t,S:15},{k:3},{h:20},{k:4}]),D(e,a){var r=a.h+B.C.h.A,t=a.g,s=e.D*a.v,n=g/a.k;for(let e=0;e<a.k;e++){var d,m=s+n*e,i=B.x+l(m)*t,o=B.y+h(m)*t;for(d of L)Q(d.x,d.y,i,o)<a.S/2+d.type.S+2&&(d.T-=r,d.P=.1,d.U=20*l(m),d.B=20*h(m),N.I+=r)}},N(e,a){var r=g/a.k,t=e.D*a.v;for(let e=0;e<a.k;e++){var s=t+r*e,n=B.x+l(s)*a.g,s=B.y+h(s)*a.g;x.i(n,s,a.S/2,w)}},O:(e,a,r)=>[["damage",E(a.h,r?.h)],["range",E(a.g,r?.g)],["speed",E(a.v,r?.v),e=>J(e)+"/s"],["blades",E(a.k,r?.k)],["size",E(a.S,r?.S)]]};let E=(e,a)=>a?a-e:e;var T={l:"Sword",q:"melee weapon",u:a([{h:8,angle:t/4,g:80,R:.5},{h:13},{angle:t/4*1.2,g:90},{h:18},{h:23},{h:28,angle:t/4*1.5},{h:33,angle:t/4*1.7,g:120}]),D(e,a){var r,t=a.h+B.C.h.A,s=a.g*B.C.g.A,a=a.angle/2,n=B.L-a,d=B.L+a;for(r of L){var m=r.x-B.x,i=r.y-B.y,o=Y(i,m),m=u(m,i),i=Y(r.type.S/2,m);n<o+i&&o-i<d&&m-r.type.S/2<s&&(r.T-=t,r.P=.1,r.U=25*l(o),r.B=25*h(o),N.I+=t)}},N(e,a){var r=a.R*B.C.$.A,t=a.g*B.C.g.A,e=.2*(e.M/r);0<e&&(r=a.angle/2,k(`rgba(255,255,255,${e})`),D.beginPath(),D.moveTo(B.x,B.y),D.lineTo(B.x+l(B.L-r)*t,B.y+h(B.L-r)*t),D.arc(B.x,B.y,t,B.L-r,B.L+r),D.lineTo(B.x,B.y),D.fill())},O:(e,a,r)=>[["damage",E(a.h,r?.h)],["range",E(a.g,r?.g)],["angle",E(a.angle,r?.angle),J]]},a={l:"Barbed Wire",q:"area damage",u:a([{g:40,h:2,R:.75},{g:60},{h:3},{g:70},{g:80},{h:4}]),D(e,a){var r,t=a.h+B.C.h.A,s=a.g*B.C.g.A;for(r of L)Q(B.x,B.y,r.x,r.y)<s&&(r.T-=t,r.P=.1,N.I+=t)},N(e,a){var r=a.R*B.C.$.A,a=a.g*B.C.g.A,e=e.M/r,r=.15+.04*l(2*e*t);x.i(B.x,B.y,a,`rgba(255,0,0,${r})`)},O:(e,a,r)=>[["damage",E(a.h,r?.h)],["range",E(a.g,r?.g)]]};let ne=e=>({K:e,D:0,M:0,W:0});var P=e=>()=>B.W*e;let de={Y:[T],C:{T:[50,P(5)],G:[45,P(.2)],H:[.05,P(.025)],V:[50],h:[P(.3)],$:[1],j:[.01],De:[1],g:[1]}};P=t=>{let s;return{l:t.l,q(){var e,a,r=s?.F??B.Y.find(e=>e.K===t);return r?s?.W===r.W?s.q:(a=r.K.u[r.W],e=r.K.u[r.W+1],a=r.K.O(r,a,e).filter(e=>!!e[1]).map(([e,a,r=b])=>`+${r(a)} `+e).join(", "),s={W:r.W,F:r,q:a},a):t.q},X(){var e=B.Y.find(e=>e.K===t);e?e.W++:B.Y.push(ne(t))},Ae:()=>B.Y.some(e=>e.K===t)?10:4,_:t.u.length-1}};let me=[{l:"Speed boost",q:"+5% speed",X(){B.C.G.J.push(.05)}},{l:"Speed base",q:"+1 base speed",X(){B.C.G.Z.push(1)}},{l:"Max health",q:"+25 max health, +5 health",X(){B.C.T.Z.push(25),B.T+=5}},{l:"Health drop",q:"+1% health drop chance",X:()=>{B.C.j.Z.push(.01)}},{l:"Regen",q:"+0.05/s health regen",X:()=>B.C.H.Z.push(.05)},{l:"Regen boost",q:"+10% health regen",X:()=>B.C.H.J.push(.1)},{l:"Pickup range",q:"+10 pickup range",X:()=>B.C.V.Z.push(10)},{l:"Damage",q:"+1 damage",X:()=>B.C.h.Z.push(1)},{l:"Attack speed",q:"+5% attack speed",X:()=>B.C.$.Z.push(-.05)},{l:"Armor",q:"+1 armor",X:()=>B.C.De.Z.push(1)},{l:"Area",q:"+10% area",X:()=>B.C.g.Z.push(.1)},P(e),P(T),P(a)],ie=e=>"function"==typeof e?e():e,U=(e=[],a=[])=>({Z:[...e],J:[...a],ee:null,get A(){var e;return this.ee?.Z===this.Z&&this.ee?.J===this.J&&this.ee?.ae===B.W?this.ee.value:(e=this.Z.reduce(e=(e,a)=>e+ie(a),0)*this.J.reduce(e,1),this.ee={Z:this.Z,J:this.J,ae:B.W,value:e},e)}}),oe=e=>({K:e,x:0,y:0,W:0,re:0,te:5,T:ie(e.C.T[0]),se:0,ne:0,oe:0,L:0,C:{G:U(e.C.G),T:U(e.C.T),H:U(e.C.H),V:U(e.C.V),h:U(e.C.h),$:U(e.C.$),j:U(e.C.j),De:U(e.C.De),g:U(e.C.g)},me:[],Y:e.Y.map(e=>ne(e))}),B=oe(de),I={RUNNING:0,de:1,ie:2,le:3,WIN:4,pe:5},le={ce:-1,runtime:0,I:0,ue:0,he:0,me:[],fe:0},N={ge:I.pe,...le};var e=e=>({...e,M:1,S:10}),T=(e,n)=>(r,t,s)=>e.map((e,a)=>x.o(r+a,t+a,n,s??e)),P=(e,n)=>(r,t,s)=>e.map((e,a)=>x.m(r+a,t+a,n,s??e)),a=(e,n)=>(r,t,s)=>e.map((e,a)=>x.i(r+a,t+a,n,s??e)),pe=e({T:10,G:26,h:10,re:1,N:T([q],10)}),ce=e({T:50,G:26,h:20,re:2,N:T([q,n],10)}),O=e({T:100,G:30,h:30,re:3,N:T([q,n,"#4a4"],10)}),T=e({T:1e3,G:30,h:30,re:100,S:20,N:T([n],20),ve:!0}),he=e({T:20,G:35,h:10,re:2,N:P([r],10)}),ue=e({T:40,G:35,h:20,re:3,N:P([r,X],10)}),fe=e({T:60,G:35,h:40,re:4,N:P([r,X,"#966"],10)}),P=e({T:3e3,G:35,h:40,re:200,ve:!0,Re:80,S:20,N:P([n],20)}),ge=e({T:10,G:40,h:10,re:3,N:a([r],5)}),ve=e({T:20,G:40,h:20,re:4,N:a([r,X],5)}),Re=e({T:50,G:40,h:40,re:5,N:a([r,X,"#4ca"],5)}),a=e({T:5e3,G:40,h:50,re:300,ve:!0,Re:80,S:16,N:a([n],8)}),e=e({T:8e3,G:60,h:100,re:0,ve:!0,Re:1e3,S:50,N(e,a,r){x.i(e,a,25,r??n),x.o(e,a,25,r??X),x.m(e,a,23,r??n)}});let we=(r,e,t=1)=>Array.from({length:o((e-r)/t)}).map((e,a)=>a*t+r);var be,ke=r=>()=>{var e=we(B.x-m,B.x+m,2*r.S),a=we(B.y-i,B.y+i,2*r.S);e.map(e=>De(e,B.y-i,r)),e.map(e=>De(e,B.y+i,r)),a.map(e=>De(B.x-m,e,r)),a.map(e=>De(B.x+m,e,r))};let xe=[{we:0,be:[pe],xe:.2},{we:30,be:[pe,he],xe:.2},{we:80,be:[pe,he],xe:.2},{we:120,be:[he],xe:.2,ve:T},{we:150,be:[he,ge],xe:.2},{we:180,be:[he,ge],xe:.2},{we:210,be:[ce],xe:.2,ke:ke(ce)},{we:240,be:[ce,ue,ge],xe:.2},{we:270,be:[ue,ge],ve:P,xe:.2},{we:300,be:[ue,ve,ce],xe:.2},{we:330,be:[ve,O],xe:.2,ke:(be=ve,()=>{var e=g/40;we(0,g,e).map(e=>{var a=B.x+l(e)*m,e=B.y+h(e)*i;De(a,e,be)})})},{we:380,be:[O,fe],xe:.2},{we:400,be:[O,fe],xe:.2},{we:450,be:[O,fe,Re],xe:.2},{we:400,be:[O,fe],ve:a,xe:.2},{we:550,be:[O,fe,Re],xe:.1,ke:ke(fe)},{we:600,be:[],xe:0,ve:e}],Se=(e,a,r)=>({x:e,y:a,type:r,T:r.T,M:0,U:0,B:0,P:0,ve:!!r.ve}),De=(e,a,r)=>L.push(Se(e,a,r)),L=[],Ae=[],ye=()=>{var e=50*o((B.x-m)/50),r=50*o((B.y-i)/50),t=50*G((B.x+m)/50),s=50*G((B.y+i)/50);for(let a=e;a<t;a+=50)for(let e=r;e<s;e+=50)x.rect(a,e,50,50,a%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000")},Ee=()=>{for(var e of B.Y)e.K.N(e,e.K.u[e.W]);x.rect(B.x-5,B.y-5,10,10,w)},Te=()=>{for(var e of L){var a=e.type;a.N(e.x,e.y,0<e.P?w:void 0),a.ve&&(x.rect(e.x-20,e.y+15,40,3,"#333"),x.rect(e.x-20,e.y+15,e.T/a.T*40,3,"#f33"))}},Pe=()=>{for(var e of Ae)x.o(e.x-3,e.y-3,10<=(e.re??0)?8:6,0<(e.T??0)?"#0c0":(e.re??0)<10?"#05f":"#ff0")},Ue=(e,a,r)=>{var s,n=[["Base damage",b(B.C.h.A)],["Attack speed",b(2-B.C.$.A,2)],["Health",o(B.C.T.A)],["Regen",b(B.C.H.A,2)+"/s"],["Armor",b(B.C.De.A)],["Speed",b(B.C.G.A,2)],["Health Drop",b(100*B.C.j.A)+"%"]];for(s of B.Y){let t=s.K.l;n.push([t+" level",s.W+1],...s.K.O(s,s.K.u[s.W]).map(([e,a,r=b])=>[t+" "+e,r(a)]))}ae(e,a,r,d-a-40,n)},Be=(e,a,r)=>{var t;for(t of[["Survived",_(N.runtime)],["Level",""+(B.W+1)],["Damage",b(N.I)],["DPS",""+b(N.I/N.runtime,2)],["Kills",""+N.ue]])x.text(e+r/2-5,a,t[0],F,V),x.text(e+r/2+5,a,t[1],w,R),a+=15;return a},Ie=()=>{if(x.rect(50,0,p-50,20,"#600"),x.rect(50,0,B.T/B.C.T.A*(p-50),20,"#f66"),x.text(52,10,o(B.T)+"/"+o(B.C.T.A),w,R,j),x.rect(50,20,p-50,12,r),x.rect(50,20,B.re/B.te*(p-50),12,w),x.text(52,27,B.re+"/"+B.te,"#000",R,j),x.rect(0,0,50,32,"#000"),x.text(25,2,"level","#666",s,v),x.text(25,18,""+(B.W+1),w,s,v),x.text(m,35,_(N.runtime),w,s),N.runtime<20){let e=d-30-15*$.length;for(var a of $)x.text(10,e,a,w,R,v),e+=15}},Ne=()=>{switch(N.ge!==I.pe&&Ie(),N.ge){case I.de:x.t(),x.text(m,100,"YOU'RE DEAD!","#f88",s,v,24),e=Be(50,145,p-100),e+=30,x.text(m,e,H,w,s);break;case I.ie:x.t(),x.text(m,10,"LEVEL UP",w,s,v);for(let e=0;e<N.me.length;e++){let a=N.me[e];var r=B.me.filter(e=>e===a).length,t=50+50*e;x.rect(20,t,p-40,40,e===N.fe?"#333":"#222"),x.rect(20,t,p-40,40,e===N.fe?"#aa3":"#444",!0),x.text(25,5+t,a.l,w),x.text(25,22+t,ie(a.q),F),x.text(20+p-50,20+t,r+"/"+(a._??5),F,V,j)}Ue(20,210,p-40);break;case I.le:x.t(),x.text(m,40,"PAUSED",w,s,j),Ue(20,80,p-40);break;case I.WIN:x.t(),x.text(m,100,"YOU WON",w,s,j);var e=Be(100,130,p-200);e+=30,x.text(m,e,H,w,s);break;case I.pe:x.t(),x.text(m,i-40,"MICRO",w,s,"bottom",68),x.text(m,i-40,"SURVIVORS",w,s,v,38),x.text(m,d-5,"by Kamen",F,s,"bottom",10),x.Se(.75+.25*l(performance.now()/1e3*5)),x.text(m,i+50,C,w,s),x.Se(1)}},Oe=()=>{var e=W(1,B.ne/.5),e=(0<e&&(e=re(80,"#f000",`rgba(255,0,0,${e})`),x.t(e)),W(1,B.oe/.1));0<e&&(e=re(130,"#fff0",`rgba(255,255,255,${.15*e})`),x.t(e))},Le=r=>{let t=0;var s,n=[];for(s of L){var d=s.type;if(s.T<=0)Ae.push({x:s.x,y:s.y,re:d.re}),c()<B.C.j.A&&Ae.push({x:s.x-5+10*c(),y:s.y-5+10*c(),T:2}),N.ue+=1,n.push(t);else{0<s.P&&(s.P-=r);let e=s.U*r,a=s.B*r;var m,i=B.x-s.x,o=B.y-s.y,l=u(i,o);!s.ve&&3*p<l?n.push(t):(s.M<=0?(l<s.type.S-2&&(B.T-=Math.max(0,d.h-B.C.De.A),B.ne=.5,s.M=d.M),m=d.G*r,e+=i/l*m,a+=o/l*m):s.M-=r,s.x+=e,s.y+=a,!(.1<f(s.U))||(i=(0<s.U?-1:1)*r*(d.Re??20),f(i)>f(s.U))?s.U=0:s.U+=i,!(.1<f(s.B))||(o=(0<s.B?-1:1)*r*(d.Re??20),f(o)>f(s.B))?s.B=0:s.B+=o)}t++}let a=0;for(let e of n)L.splice(e-a,1),a+=1},Me=e=>{var a=c()*g,r=Math.max(p,d)/2,r=u(r,r)+15*c();L.push(Se(B.x+l(a)*r,B.y+h(a)*r,e))},$e=()=>{Object.assign(B,oe(de)),Object.assign(N,le),N.ge=I.RUNNING,L.length=0,Ae.length=0},Ge=e=>{switch(N.ge){case I.RUNNING:N.runtime+=e,y.pause&&(N.ge=I.le),B.T<=0&&(N.ge=I.de);var a=xe.findIndex(e=>e.we>N.runtime)-1,r=xe[a<0?xe.length-1:a];if(-2==a&&0===L.length&&(N.ge=I.WIN),r){for(a!==N.ce&&(N.ce=a,r.ve&&Me(r.ve),r.ke?.());r.xe&&N.he>r.xe;)0<r.be.length&&Me(ee(r.be)),N.he-=r.xe;N.he+=e}break;case I.WIN:case I.de:case I.pe:A.enter&&$e();break;case I.ie:y.up&&0<N.fe&&N.fe--,y.down&&N.fe<N.me.length-1&&N.fe++,y.enter&&((a=N.me[N.fe]).X(),B.me.push(a),N.ge=I.RUNNING);break;case I.le:(y.pause||y.enter)&&(N.ge=I.RUNNING)}},Ke=()=>{for(var e in y)y[e]=!1},We=e=>{let a=0,r=0;A.up&&--r,A.down&&(r+=1),A.left&&--a,A.right&&(a+=1);var t,s,n=B.C.G.A*e,d=u(a,r),d=(0<d&&(B.x+=a/d*n,B.y+=r/d*n),m),n=i;B.L=Y(A.targetY-n,A.targetX-d),B.re>=B.te&&(B.W+=1,B.re-=B.te,B.te+=10,n=me.filter(a=>!(a.condition&&!a.condition()||B.me.filter(e=>e===a).length>=(a._??5))).map(e=>({A:e,weight:e.Ae?.()??10})),N.me=Z(n).slice(0,3),0<N.me.length&&(N.ge=I.ie),B.T+=5),0<B.ne&&(B.ne-=e),0<B.oe&&(B.oe-=e),B.T=W(B.C.T.A,B.T+B.C.H.A*e);for(t of B.Y)t.D+=e,t.M<=0?(s=t.K.u[t.W],t.K.D(t,s),t.M=s.R*B.C.$.A):t.M-=e},Ye=e=>{let a=0;var r,t=[];for(r of Ae){var s,n=B.x-r.x,d=B.y-r.y,m=u(n,d);m<10?(B.T=W(B.C.T.A,B.T+(r.T??0)),B.re+=r.re??0,B.oe=.1,t.push(a)):m<B.C.V.A&&(s=(B.C.V.A+10-m)*e*2,r.x+=n/m*s,r.y+=d/m*s),a++}let i=0;for(let e of t)Ae.splice(e-i,1),i+=1},Ce=0,He=e=>{requestAnimationFrame(He);var a=(e-Ce)/1e3;Ce=e,D.reset(),D.clearRect(0,0,p,d),D.translate(-B.x+m,-B.y+i),ye(),Pe(),Ee(),Te(),D.resetTransform(),Oe(),Ne(),e=a,Ge(e),N.ge===I.RUNNING&&(Le(e),Ye(e),We(e)),Ke()};return M.appendChild(S),requestAnimationFrame(He),[B,N]}