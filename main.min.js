function microSurvivors(m=document.body,N=400,p=400){let h=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],U=N/2,z=p/2,{floor:H,ceil:x,random:M,round:g,cos:W,sin:$,min:O,hypot:K,abs:Y,atan2:Z,PI:u}=Math,G=2*u;var e="Press ENTER to ";let v=e+"start",w=e+"restart",S=(e,a=2,r="0")=>e.toString().padStart(a,r);function R(e){var a=H(e/60),e=H(e%60);return S(a)+":"+S(e)}let E=e=>l(e*(180/u)),l=(e,a=0)=>e.toFixed(a),ee=(e,a,r,t)=>K(r-e,t-a);let ae=e=>e[g(M()*(e.length-1))],b={rect(e,a,r,t,n){k.fillStyle=n,k.fillRect(e,a,r,t)},t(e="#000000e5"){k.fillStyle=e,k.fillRect(0,0,N,p)},o(e,a,r,t){k.fillStyle=t,k.fillRect(e-r/2,a-r/2,r,r)},l(e,a,r,t){k.fillStyle=t,k.beginPath(),k.moveTo(e,a-r/2),k.lineTo(e-r/2,a+r/2),k.lineTo(e+r/2,a+r/2),k.fill()},text(e,a,r,t,n="left",s="top",o=14){k.font=o+"px monospace",k.fillStyle=t,k.textAlign=n,k.textBaseline=s,k.fillText(r,e,a)},i(e,a,r,t){k.fillStyle=t,k.beginPath(),k.arc(e,a,r,0,G),k.fill()}},D=(e,a,r,t,n)=>{var s,o,f=a,p=r/2;15*n.length<t&&(e+=r/4);for([s,o]of n)b.text(e,a,s+":","#aaa"),b.text(e+p-5,a,""+o,"#fff","right"),f+t<(a+=15)&&(a=f,e+=p)},A=(e,a,r)=>{e=k.createRadialGradient(U,z,e,U,z,U);return e.addColorStop(0,a),e.addColorStop(1,r),e},y=document.createElement("canvas"),k=(y.width=N,y.height=p,y.getContext("2d")??(()=>{throw new Error})()),C={arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",w:"up",s:"down",a:"left",d:"right",enter:"enter",escape:"pause",p:"pause"},V={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},X={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},T=(e,a)=>{e=C[e.key.toLowerCase()];e&&(V[e]=a,X[e]=a)};e="addEventListener";document[e]("keydown",e=>T(e,!0)),document[e]("keyup",e=>T(e,!1)),y[e]("mousemove",e=>{var a=y.getBoundingClientRect();V.targetX=e.clientX-a.left,V.targetY=e.clientY-a.top});let q={m:0,h:1,g:2};var e=a=>{let r=a[0];var t=[a[0]];for(let e=1;e<a.length;e++)r={...r,...a[e]},t[e]=r;return t},a={name:"Saw Blades",type:q.m,v:e([{damage:5,range:50,rotationSpeed:u/2,u:.1,blades:1,size:10},{blades:2},{damage:10,rotationSpeed:u/1.5},{rotationSpeed:u/1.25,size:15},{blades:3},{damage:15},{blades:4}])},r={name:"Sword",type:q.h,v:e([{damage:8,angle:u/4,range:80,k:.5},{damage:13},{angle:u/4*1.2,range:90},{damage:18},{damage:23},{damage:28,angle:u/4*1.5},{damage:33,angle:u/4*1.7,range:120}])},e={name:"Barbed Wire",type:q.g,v:e([{range:40,damage:2,k:.75},{range:60},{damage:3},{range:70},{range:80},{damage:4}])};let B=e=>({type:e,S:0,R:0,level:0});var t=r=>(e,a)=>a+e.level*r,n=e=>()=>e;let re={D:[r],A:{health:[n(100),t(10)],speed:[n(45),t(.2)],healthRegen:[n(.1),t(.025)],pickupDistance:[n(50)],damage:[t(.3)],attackSpeed:[n(1)],healthDrop:[n(.01)]}};var t=(a,r)=>e=>e.A[a].push("base",(e,a)=>a+r),n=(a,r)=>e=>e.A[a].push("multiplier",(e,a)=>a*r),s=(f,e)=>{let p;return{name:e,description:()=>{var e=p?.C??F.D.find(e=>e.type===f);if(!e)return"New weapon";if(p?.level===e.level)return p.T;var a,r,t=e.type.v[e.level],n=e.type.v[e.level+1],s=[];for(a in n)n[a]!==t[a]&&(r=n[a]-t[a],r="angle"===a?E(r)+"°":l(r),s.push(`+${r} `+a));var o=s.join(", ");return p={level:e.level,C:e,T:o},o},apply:e=>{var a=e.D.find(e=>e.type===f);a?a.level++:e.D.push(B(f))},B:f.v.length}};let te=[{name:"Speed boost",description:"+25% speed",apply:n("speed",1.25),B:5},{name:"Speed base",description:"+1 base speed",apply:t("speed",1),B:5},{name:"Heal",description:"+25 health",P:e=>e.health+25<e.A.health.value,apply:e=>e.health+=25,B:5},{name:"Max health",description:"+25 max health, +5 health",apply:e=>{e.A.health.push("base",(e,a)=>a+25),e.health+=5},B:5},{name:"Health drop",description:"+1% health drop chance",apply:t("healthDrop",.01),B:5},{name:"Regen",description:"+0.1/s health regen",apply:t("healthRegen",.1),B:5},{name:"Regen boost",description:"+10% health regen",apply:n("healthRegen",1.1),B:5},{name:"Pickup range",description:"+10 pickup range",apply:t("pickupDistance",10),B:5},{name:"Damage",description:"+1 damage",apply:t("damage",1),B:5},{name:"Attack speed",description:"+5% attack speed",apply:t("attackSpeed",-.05),B:5},s(a,"Saw Blades"),s(r,"Sword"),s(e,"Barbed Wire")],o=(e=[],a=[])=>({push(e,a){this[e]=[...this[e],a]},base:[...e],multiplier:[...a],I:null,get value(){var e;return this.I?.base===this.base&&this.I?.multiplier===this.multiplier&&this.I?.L===F.level?this.I.value:(e=this.base.reduce((e,a)=>a(F,e),0)*this.multiplier.reduce((e,a)=>a(F,e),1),this.I={base:this.base,multiplier:this.multiplier,L:F.level,value:e},e)}}),ne=e=>({type:e,x:0,y:0,level:0,N:0,U:5,health:100,H:0,M:0,W:0,$:0,A:{speed:o(e.A.speed),health:o(e.A.health),healthRegen:o(e.A.healthRegen),pickupDistance:o(e.A.pickupDistance),damage:o(e.A.damage),attackSpeed:o(e.A.attackSpeed),healthDrop:o(e.A.healthDrop)},O:[],D:e.D.map(e=>B(e))}),F=ne(re),_={RUNNING:0,K:1,Y:2,G:3,WIN:4,V:5},se={X:-1,runtime:0,q:0,F:0,_:0,O:[],j:0},j={state:_.V,...se};var n=e=>({...e,R:1,size:10}),t=(e,s)=>(r,t,n)=>e.map((e,a)=>b.o(r+a,t+a,s,n??e)),a=(e,s)=>(r,t,n)=>e.map((e,a)=>b.l(r+a,t+a,s,n??e)),r=(e,s)=>(r,t,n)=>e.map((e,a)=>b.i(r+a,t+a,s,n??e)),s=n({health:10,speed:26,damage:1,N:1,J:t(["#aaa"],10)}),e=n({health:50,speed:26,damage:1,N:2,J:t(["#aaa","#faa"],10)}),f=n({health:100,speed:30,damage:2,N:3,J:t(["#aaa","#faa","#4a4"],10)}),t=n({health:500,speed:30,damage:10,N:20,size:20,J:t(["#faa"],20),Z:!0}),i=n({health:20,speed:35,damage:2,N:2,J:a(["#999"],10)}),P=n({health:40,speed:35,damage:2,N:3,J:a(["#999","#0ac"],10)}),c=n({health:60,speed:35,damage:3,N:4,J:a(["#999","#0ac","#966"],10)}),a=n({health:1e3,speed:35,damage:10,N:50,Z:!0,ee:80,size:20,J:a(["#faa"],20)}),I=n({health:10,speed:40,damage:1,N:3,J:r(["#999"],5)}),L=n({health:20,speed:40,damage:1,N:4,J:r(["#999","#0ac"],5)}),oe=n({health:50,speed:40,damage:1,N:5,J:r(["#999","#0ac","#4ca"],5)}),r=n({health:1e3,speed:40,damage:5,N:4,Z:!0,ee:80,size:16,J:r(["#faa"],8)}),n=n({health:1e4,speed:55,damage:5,N:0,Z:!0,ee:1e3,size:50,J(e,a,r){b.i(e,a,25,r??"#faa"),b.o(e,a,25,r??"#0ac"),b.l(e,a,23,r??"#faa")}});let fe=(r,e,t=1)=>Array.from({length:H((e-r)/t)}).map((e,a)=>a*t+r);var pe,le=r=>()=>{var e=fe(F.x-U,F.x+U,2*r.size),a=fe(F.y-z,F.y+z,2*r.size);e.map(e=>d(e,F.y-z,r)),e.map(e=>d(e,F.y+z,r)),a.map(e=>d(F.x-U,e,r)),a.map(e=>d(F.x+U,e,r))};let ie=[{from:0,types:[s],rate:.4},{from:30,types:[s,i],rate:.5},{from:80,types:[s,i],rate:.4},{from:120,types:[i],rate:.3,Z:t},{from:150,types:[i,I],rate:.4},{from:200,types:[i,I],rate:.3},{from:250,types:[e],rate:.3,ae:le(e)},{from:300,types:[e,P,I],rate:.3},{from:330,types:[P,I],Z:a,rate:.3},{from:380,types:[P,L,e],rate:.3},{from:450,types:[L,f],rate:.4,ae:(pe=L,()=>{var e=G/40;fe(0,G,e).map(e=>{var a=F.x+W(e)*U,e=F.y+$(e)*z;d(a,e,pe)})})},{from:500,types:[f,c],rate:.3},{from:550,types:[f,c],rate:.25},{from:600,types:[f,c,oe],rate:.25},{from:650,types:[f,c],Z:r,rate:.4},{from:700,types:[f,c,oe],rate:.25,ae:le(c)},{from:720,types:[],rate:0,Z:n}],ce=(e,a,r)=>({x:e,y:a,type:r,health:r.health,R:0,re:0,te:0,ne:0,Z:!!r.Z}),d=(e,a,r)=>J.push(ce(e,a,r)),J=[],de={se:0,oe:1},Q=[];function me(e,a,r){var t,n=[["Base damage",l(F.A.damage.value)],["Attack speed",l(F.A.attackSpeed.value,2)],["Health",H(F.A.health.value)],["Regeneration",l(F.A.healthRegen.value,2)+"/s"],["Speed",l(F.A.speed.value,2)],["Health Drop",l(100*F.A.healthDrop.value)+"%"]];for(t of F.D){var s=t.type.name;switch(t.type.type){case q.h:var o=t.type.v[t.level];n.push([s+" level",t.level+1]),n.push([s+" damage",l(o.damage)]),n.push([s+" range",l(o.range)]),n.push([s+" angle",E(o.angle)+"°"]);break;case q.m:o=t.type.v[t.level];n.push([s+" level",t.level+1]),n.push([s+" damage",l(o.damage)]),n.push([s+" range",l(o.range)]),n.push([s+" blades",l(o.blades)]),n.push([s+" size",l(o.size)]);break;case q.g:var f=t.type.v[t.level];n.push([s+" level",t.level+1]),n.push([s+" damage",l(f.damage)]),n.push([s+" range",l(f.range)])}}D(e,a,r,p-a-20,n)}function he(e,a,r){var t;for(t of[["Survived",R(j.runtime)],["Level",""+(F.level+1)],["Damage",l(j.q)],["DPS",""+l(j.q/j.runtime,2)],["Kills",""+j.F]])b.text(e+r/2-5,a,t[0],"#ccc","right"),b.text(e+r/2+5,a,t[1],"#fff","left"),a+=15;return a}function ge(){if(j.state!==_.V&&(b.rect(50,0,N-50,20,"#600"),b.rect(50,0,F.health/F.A.health.value*(N-50),20,"#f66"),b.text(52,10,H(F.health)+" / "+H(F.A.health.value),"#fff","left","middle"),b.rect(50,20,N-50,12,"#999"),b.rect(50,20,F.N/F.U*(N-50),12,"#fff"),b.text(52,27,F.N+" / "+F.U,"#000","left","middle"),b.rect(0,0,50,32,"#000"),b.text(25,2,"level","#666","center","top"),b.text(25,18,""+(F.level+1),"#fff","center","top"),b.text(U,35,R(j.runtime),"#fff","center"),j.runtime<20)){let e=p-30-15*h.length;for(var a of h)b.text(10,e,a,"#fff","left","top"),e+=15}switch(j.state){case _.K:b.t(),b.text(U,100,"YOU'RE DEAD!","#f88","center","top",24),e=he(50,145,N-100),e+=30,b.text(U,e,w,"#fff","center");break;case _.Y:b.t(),b.text(U,10,"LEVEL UP","#fff","center","top");for(let e=0;e<j.O.length;e++){let a=j.O[e];var r=F.O.filter(e=>e===a).length,t=50+50*e;k.textAlign="left",k.textBaseline="top",k.fillStyle=e===j.j?"#333":"#222",k.fillRect(20,t,N-40,40),k.strokeStyle=e===j.j?"#aa3":"#444",k.strokeRect(20,t,N-40,40),k.fillStyle="#fff",k.fillText(a.name,25,5+t),k.fillStyle="#ccc",k.fillText("function"==typeof a.description?a.description():a.description,25,22+t),b.text(20+N-50,20+t,r+"/"+a.B,"#ccc","right","middle")}me(20,210,N-40);break;case _.G:b.t(),b.text(U,100,"PAUSED","#fff","center","middle"),me(20,110,N-40);break;case _.WIN:b.t(),b.text(U,100,"YOU WON","#fff","center","middle");var e=he(100,130,N-200);e+=30,b.text(U,e,w,"#fff","center");break;case _.V:b.t(),b.text(U,z-40,"MICRO","#fff","center","bottom",68),b.text(U,z-40,"SURVIVORS","#fff","center","top",38),b.text(U,p-5,"by Kamen","#ccc","center","bottom",10),k.globalAlpha=.5+.5*(.5*W(performance.now()/1e3*5)+.5),b.text(U,z+50,v,"#fff","center"),k.globalAlpha=1}}function ve(){k.reset(),k.clearRect(0,0,y.width,y.height),k.translate(-F.x+U,-F.y+z);var e,a,r,t=50*H((F.x-U)/50),n=50*H((F.y-z)/50),s=50*x((F.x+U)/50),o=50*x((F.y+z)/50);for(let a=t;a<s;a+=50)for(let e=n;e<o;e+=50)b.rect(a,e,50,50,a%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000");for(e of Q)b.o(e.x-3,e.y-3,10<=(e.N??0)?8:6,0<(e.health??0)?"#0c0":(e.N??0)<10?"#05f":"#ff0");for(a of F.D)switch(a.type.type){case q.m:var f=a.type.v[a.level],p=G/f.blades,l=a.S*f.rotationSpeed;for(let e=0;e<f.blades;e++){var i=l+p*e,c=F.x+W(i)*f.range,i=F.y+$(i)*f.range;b.i(c,i,f.size/2,"#fff")}break;case q.h:var d=a.type.v[a.level],m=d.k*F.A.attackSpeed.value,m=.2*(a.R/m);0<m&&(h=d.angle/2,k.fillStyle=`rgba(255,255,255,${m})`,k.beginPath(),k.moveTo(F.x,F.y),k.lineTo(F.x+W(F.$-h)*d.range,F.y+$(F.$-h)*d.range),k.arc(F.x,F.y,d.range,F.$-h,F.$+h),k.lineTo(F.x,F.y),k.fill());break;case q.g:var m=a.type.v[a.level],d=m.k*F.A.attackSpeed.value,h=a.R/d,g=.15+.02*W(2*h*u);b.i(F.x,F.y,m.range,`rgba(255,0,0,${g})`)}b.rect(F.x-5,F.y-5,10,10,"#fff");for(r of J){var v=r.type;v.J(r.x,r.y,0<r.ne?"#fff":void 0),v.Z&&(b.rect(r.x-20,r.y+15,40,3,"#333"),b.rect(r.x-20,r.y+15,r.health/v.health*40,3,"#f33"))}k.resetTransform(),0<(t=O(1,F.M/.5))&&(t=A(80,"#ff000000",`rgba(255,0,0,${t})`),b.t(t)),0<(t=O(1,F.W/.1))&&(t=A(130,"#ffffff00",`rgba(255,255,255,${.15*t})`),b.t(t)),ge()}function ue(n){var e,a,r,t=n;switch(j.state){case _.RUNNING:(j.runtime+=t,X.pause)?j.state=_.G:F.health<=0?j.state=_.K:(a=ie.findIndex(e=>e.from>j.runtime)-1,e=ie[a<0?ie.length-1:a],-2==a&&0===J.length&&(j.state=_.WIN),e&&(a!==j.X&&(j.X=a,e.Z&&be(e.Z),e.ae?.()),j._>e.rate?(0<e.types.length&&be(ae(e.types)),j._=0):j._+=t));break;case _.WIN:case _.K:case _.V:V.enter&&(()=>{for(var e in F=ne(re),se)j[e]=se[e];j.state=_.RUNNING,J.length=0,Q.length=0})();break;case _.Y:X.up&&0<j.j&&j.j--,X.down&&j.j<j.O.length-1&&j.j++,X.enter&&((a=j.O[j.j]).apply(F),F.O.push(a),j.state=_.RUNNING);break;case _.G:(X.pause||X.enter)&&(j.state=_.RUNNING)}if(j.state===_.RUNNING){{var s,o=n;let r=0,t=[];for(s of J){var f=s.type;if(s.health<=0)Q.push({x:s.x,y:s.y,type:de.oe,N:f.N}),M()<F.A.healthDrop.value&&Q.push({x:s.x-5+10*M(),y:s.y-5+10*M(),type:de.se,health:10}),j.F+=1,t.push(r);else{0<s.ne&&(s.ne-=o);let e=s.re*o,a=s.te*o;var p,l=F.x-s.x,i=F.y-s.y,c=K(l,i);!s.Z&&3*N<c?t.push(r):(s.R<=0?(c<s.type.size-2&&(F.health-=f.health,F.M=.5,s.R=f.R),p=f.speed*o,e+=l/c*p,a+=i/c*p):s.R-=o,s.x+=e,s.y+=a,!(.1<Y(s.re))||(l=(0<s.re?-1:1)*o*(f.ee??20),Y(l)>Y(s.re))?s.re=0:s.re+=l,!(.1<Y(s.te))||(i=(0<s.te?-1:1)*o*(f.ee??20),Y(i)>Y(s.te))?s.te=0:s.te+=i)}r++}let a=0;for(let e of t)J.splice(e-a,1),a+=1}{var d,m=n;let e=0,a=[];for(d of Q){var h,g=F.x-d.x,v=F.y-d.y,u=K(g,v);if(u<10){switch(d.type){case de.se:F.health=O(F.A.health.value,F.health+(d.health??0));break;case de.oe:F.N+=d.N??0}F.W=.1,a.push(e)}else u<F.A.pickupDistance.value&&(h=(F.A.pickupDistance.value+10-u)*m*2,d.x+=g/u*h,d.y+=v/u*h);e++}let r=0;for(let e of a)Q.splice(e-r,1),r+=1}{var b=n;let e=0,a=0;V.up&&--a,V.down&&(a+=1),V.left&&--e,V.right&&(e+=1);var y,n=F.A.speed.value*b,k=K(e,a);0<k&&(F.x+=e/k*n,F.y+=a/k*n),k=U,n=z,F.$=Z(V.targetY-n,V.targetX-k),F.N>=F.U&&(F.level+=1,F.N-=F.U,F.U+=10,n=te.filter(a=>!(a.P&&!a.P(F)||a.B&&F.O.filter(e=>e===a).length>=a.B)),j.O=(a=>{for(let e=a.length-1;0<=e;e--){var r=H(M()*(e+1));[a[e],a[r]]=[a[r],a[e]]}return a})(n).slice(0,3),0<j.O.length&&(j.state=_.Y),F.health+=5),0<F.M&&(F.M-=b),0<F.W&&(F.W-=b),F.health=O(F.A.health.value,F.health+F.A.healthRegen.value*b);for(y of F.D)switch(y.S+=b,y.type.type){case q.m:var x=y.type.v[y.level],w=x.damage+F.A.damage.value;if(y.R<=0){y.R=x.u*F.A.attackSpeed.value;var S=G/x.blades,R=y.S*x.rotationSpeed;for(let e=0;e<x.blades;e++){var E,D=R+S*e,A=F.x+W(D)*x.range,C=F.y+$(D)*x.range;for(E of J)ee(E.x,E.y,A,C)<x.size/2+E.type.size+2&&(E.health-=w,E.ne=.1,E.re=20*W(D),E.te=20*$(D),j.q+=w)}}else y.R-=b;break;case q.h:0<y.R?y.R-=b:(((e,a)=>{var r,t=a.v[e.level],n=t.damage+F.A.damage.value,a=t.angle/2,s=F.$-a,o=F.$+a;for(r of J){var f=r.x-F.x,p=r.y-F.y,l=Z(p,f),f=K(f,p),p=Z(r.type.size/2,f);s<l+p&&l-p<o&&f-r.type.size/2<t.range&&(r.health-=n,r.ne=.1,r.re=25*W(l),r.te=25*$(l),j.q+=n)}})(y,y.type),y.R=y.type.v[y.level].k*F.A.attackSpeed.value);break;case q.g:if(0<y.R)y.R-=b;else{var T,B=y.type.v[y.level],P=B.damage+F.A.damage.value;for(T of J){var I=T.x-F.x,L=T.y-F.y;let e=K(I,L);e<B.range&&(T.health-=P,T.ne=.1,j.q+=P)}y.R=y.type.v[y.level].k*F.A.attackSpeed.value}}}}for(r in X)X[r]=!1}function be(e){var a=M()*G,r=Math.max(N,p)/2,r=K(r,r)+15*M();J.push(ce(F.x+W(a)*r,F.y+$(a)*r,e))}let ye=0;return m.appendChild(y),requestAnimationFrame(function e(a){requestAnimationFrame(e);var r=(a-ye)/1e3;ye=a,ve(),ue(r)}),[F,j]}