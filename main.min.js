function microSurvivors(x=document.body,w=400,s=400){let L=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],R=w/2,S=s/2,{floor:D,ceil:$,random:A,round:M,cos:m,sin:h,min:C,hypot:E,abs:T,atan2:H,PI:r}=Math,g=2*r;var e="Press ENTER to ";let K=e+"start",W=e+"restart",Y=(e,a=2,t="0")=>e.toString().padStart(a,t);function G(e){var a=D(e/60),e=D(e%60);return Y(a)+":"+Y(e)}let V=e=>l(e*(180/r)),l=(e,a=0)=>e.toFixed(a);let j=e=>e[M(A()*(e.length-1))],i={rect(e,a,t,r,n){d.fillStyle=n,d.fillRect(e,a,t,r)},t(e="#000000e5"){d.fillStyle=e,d.fillRect(0,0,w,s)},o(e,a,t,r){d.fillStyle=r,d.fillRect(e-t/2,a-t/2,t,t)},l(e,a,t,r){d.fillStyle=r,d.beginPath(),d.moveTo(e,a-t/2),d.lineTo(e-t/2,a+t/2),d.lineTo(e+t/2,a+t/2),d.fill()},text(e,a,t,r,n="left",o="top",s=14){d.font=s+"px monospace",d.fillStyle=r,d.textAlign=n,d.textBaseline=o,d.fillText(t,e,a)},i(e,a,t,r){d.fillStyle=r,d.beginPath(),d.arc(e,a,t,0,g),d.fill()}},q=(e,a,t,r,n)=>{var o,s,f=a,p=t/2;15*n.length<r&&(e+=t/4);for([o,s]of n)i.text(e,a,o+":","#aaa"),i.text(e+p-5,a,""+s,"#fff","right"),f+r<(a+=15)&&(a=f,e+=p)},F=(e,a,t)=>{e=d.createRadialGradient(R,S,e,R,S,R);return e.addColorStop(0,a),e.addColorStop(1,t),e},p=document.createElement("canvas"),d=(p.width=w,p.height=s,p.getContext("2d")??(()=>{throw new Error})()),X={arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",w:"up",s:"down",a:"left",d:"right",enter:"enter",escape:"pause",p:"pause"},P={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},U={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},_=(e,a)=>{e=X[e.key.toLowerCase()];e&&(P[e]=a,U[e]=a)};var e="addEventListener",e=(document[e]("keydown",e=>_(e,!0)),document[e]("keyup",e=>_(e,!1)),p[e]("mousemove",e=>{var a=p.getBoundingClientRect();P.targetX=e.clientX-a.left,P.targetY=e.clientY-a.top}),a=>{let t=a[0];var r=[a[0]];for(let e=1;e<a.length;e++)t={...t,...a[e]},r[e]=t;return r}),a={name:"Saw Blades",m:e([{damage:5,range:50,rotationSpeed:r/2,h:.1,blades:1,size:10},{blades:2},{damage:10,rotationSpeed:r/1.5},{rotationSpeed:r/1.25,size:15},{blades:3},{damage:15},{blades:4}]),g(e,a){var t,r,n,o,s=a.damage+z.v.damage.value,f=g/a.blades,p=e.g*a.rotationSpeed;for(let e=0;e<a.blades;e++){var l,i=p+f*e,d=z.x+m(i)*a.range,c=z.y+h(i)*a.range;for(l of N)t=l.x,r=l.y,n=d,o=c,E(n-t,o-r)<a.size/2+l.type.size+2&&(l.health-=s,l.u=.1,l.k=20*m(i),l.R=20*h(i),I.S+=s)}},D(e,a){var t=g/a.blades,r=e.g*a.rotationSpeed;for(let e=0;e<a.blades;e++){var n=r+t*e,o=z.x+m(n)*a.range,n=z.y+h(n)*a.range;i.i(o,n,a.size/2,"#fff")}},A:(e,a)=>[[e.name+" damage",l(a.damage)],[e.name+" range",l(a.range)],[e.name+" blades",l(a.blades)],[e.name+" size",l(a.size)]]},t={name:"Sword",m:e([{damage:8,angle:r/4,range:80,C:.5},{damage:13},{angle:r/4*1.2,range:90},{damage:18},{damage:23},{damage:28,angle:r/4*1.5},{damage:33,angle:r/4*1.7,range:120}]),g(e,a){var t,r=a.damage+z.v.damage.value,n=a.angle/2,o=z.T-n,s=z.T+n;for(t of N){var f=t.x-z.x,p=t.y-z.y,l=H(p,f),f=E(f,p),p=H(t.type.size/2,f);o<l+p&&l-p<s&&f-t.type.size/2<a.range&&(t.health-=r,t.u=.1,t.k=25*m(l),t.R=25*h(l),I.S+=r)}},D(e,a){var t=a.C*z.v.attackSpeed.value,e=.2*(e.P/t);0<e&&(t=a.angle/2,d.fillStyle=`rgba(255,255,255,${e})`,d.beginPath(),d.moveTo(z.x,z.y),d.lineTo(z.x+m(z.T-t)*a.range,z.y+h(z.T-t)*a.range),d.arc(z.x,z.y,a.range,z.T-t,z.T+t),d.lineTo(z.x,z.y),d.fill())},A:(e,a)=>[[e.name+" damage",l(a.damage)],[e.name+" range",l(a.range)],[e.name+" angle",V(a.angle)+"°"]]},e={name:"Barbed Wire",m:e([{range:40,damage:2,C:.75},{range:60},{damage:3},{range:70},{range:80},{damage:4}]),g(e,a){var t,r=a.damage+z.v.damage.value;for(t of N){var n=t.x-z.x,o=t.y-z.y;E(n,o)<a.range&&(t.health-=r,t.u=.1,I.S+=r)}},D(e,a){var t=a.C*z.v.attackSpeed.value,e=e.P/t,t=.15+.02*m(2*e*r);i.i(z.x,z.y,a.range,`rgba(255,0,0,${t})`)},A:(e,a)=>[[e.name+" damage",l(a.damage)],[e.name+" range",l(a.range)]]};let J=e=>({type:e,g:0,P:0,level:0});var n=e=>()=>z.level*e;let Q={U:[t],v:{health:[100,n(10)],speed:[45,n(.2)],healthRegen:[.1,n(.025)],pickupDistance:[50],damage:[n(.3)],attackSpeed:[1],healthDrop:[.01]}};var n=(a,t)=>e=>e.v[a].base.push(t),o=(a,t)=>e=>e.v[a].base.push(t),f=f=>{let p;return{name:f.name,description:()=>{var e=p?.B??z.U.find(e=>e.type===f);if(!e)return"New weapon";if(p?.level===e.level)return p.I;var a,t,r=e.type.m[e.level],n=e.type.m[e.level+1],o=[];for(a in n)n[a]!==r[a]&&(t=n[a]-r[a],t="angle"===a?V(t)+"°":l(t),o.push(`+${t} `+a));var s=o.join(", ");return p={level:e.level,B:e,I:s},s},apply:e=>{var a=e.U.find(e=>e.type===f);a?a.level++:e.U.push(J(f))},N:f.m.length}};let Z=[{name:"Speed boost",description:"+25% speed",apply:o("speed",1.25),N:5},{name:"Speed base",description:"+1 base speed",apply:n("speed",1),N:5},{name:"Heal",description:"+25 health",O:e=>e.health+25<e.v.health.value,apply:e=>e.health+=25,N:5},{name:"Max health",description:"+25 max health, +5 health",apply:e=>{e.v.health.base.push(25),e.health+=5},N:5},{name:"Health drop",description:"+1% health drop chance",apply:n("healthDrop",.01),N:5},{name:"Regen",description:"+0.1/s health regen",apply:n("healthRegen",.1),N:5},{name:"Regen boost",description:"+10% health regen",apply:o("healthRegen",1.1),N:5},{name:"Pickup range",description:"+10 pickup range",apply:n("pickupDistance",10),N:5},{name:"Damage",description:"+1 damage",apply:n("damage",1),N:5},{name:"Attack speed",description:"+5% attack speed",apply:n("attackSpeed",-.05),N:5},f(a),f(t),f(e)],ee=e=>"function"==typeof e?e():e,c=(e=[],a=[])=>({base:[...e],multiplier:[...a],L:null,get value(){var e;return this.L?.base===this.base&&this.L?.multiplier===this.multiplier&&this.L?.$===z.level?this.L.value:(e=this.base.reduce(e=(e,a)=>e+ee(a),0)*this.multiplier.reduce(e,1),this.L={base:this.base,multiplier:this.multiplier,$:z.level,value:e},e)}}),ae=e=>({type:e,x:0,y:0,level:0,M:0,H:5,health:100,K:0,W:0,Y:0,T:0,v:{speed:c(e.v.speed),health:c(e.v.health),healthRegen:c(e.v.healthRegen),pickupDistance:c(e.v.pickupDistance),damage:c(e.v.damage),attackSpeed:c(e.v.attackSpeed),healthDrop:c(e.v.healthDrop)},G:[],U:e.U.map(e=>J(e))}),z=ae(Q),B={RUNNING:0,V:1,j:2,q:3,WIN:4,F:5},te={X:-1,runtime:0,S:0,_:0,J:0,G:[],Z:0},I={state:B.F,...te};var o=e=>({...e,P:1,size:10}),n=(e,o)=>(t,r,n)=>e.map((e,a)=>i.o(t+a,r+a,o,n??e)),a=(e,o)=>(t,r,n)=>e.map((e,a)=>i.l(t+a,r+a,o,n??e)),t=(e,o)=>(t,r,n)=>e.map((e,a)=>i.i(t+a,r+a,o,n??e)),f=o({health:10,speed:26,damage:1,M:1,D:n(["#aaa"],10)}),e=o({health:50,speed:26,damage:1,M:2,D:n(["#aaa","#faa"],10)}),v=o({health:100,speed:30,damage:2,M:3,D:n(["#aaa","#faa","#4a4"],10)}),n=o({health:500,speed:30,damage:10,M:20,size:20,D:n(["#faa"],20),ee:!0}),u=o({health:20,speed:35,damage:2,M:2,D:a(["#999"],10)}),re=o({health:40,speed:35,damage:2,M:3,D:a(["#999","#0ac"],10)}),y=o({health:60,speed:35,damage:3,M:4,D:a(["#999","#0ac","#966"],10)}),a=o({health:1e3,speed:35,damage:10,M:50,ee:!0,ae:80,size:20,D:a(["#faa"],20)}),b=o({health:10,speed:40,damage:1,M:3,D:t(["#999"],5)}),ne=o({health:20,speed:40,damage:1,M:4,D:t(["#999","#0ac"],5)}),oe=o({health:50,speed:40,damage:1,M:5,D:t(["#999","#0ac","#4ca"],5)}),t=o({health:1e3,speed:40,damage:5,M:4,ee:!0,ae:80,size:16,D:t(["#faa"],8)}),o=o({health:1e4,speed:55,damage:5,M:0,ee:!0,ae:1e3,size:50,D(e,a,t){i.i(e,a,25,t??"#faa"),i.o(e,a,25,t??"#0ac"),i.l(e,a,23,t??"#faa")}});let se=(t,e,r=1)=>Array.from({length:D((e-t)/r)}).map((e,a)=>a*r+t);var fe,pe=t=>()=>{var e=se(z.x-R,z.x+R,2*t.size),a=se(z.y-S,z.y+S,2*t.size);e.map(e=>k(e,z.y-S,t)),e.map(e=>k(e,z.y+S,t)),a.map(e=>k(z.x-R,e,t)),a.map(e=>k(z.x+R,e,t))};let le=[{from:0,types:[f],rate:.4},{from:30,types:[f,u],rate:.5},{from:80,types:[f,u],rate:.4},{from:120,types:[u],rate:.3,ee:n},{from:150,types:[u,b],rate:.4},{from:200,types:[u,b],rate:.3},{from:250,types:[e],rate:.3,te:pe(e)},{from:300,types:[e,re,b],rate:.3},{from:330,types:[re,b],ee:a,rate:.3},{from:380,types:[re,ne,e],rate:.3},{from:450,types:[ne,v],rate:.4,te:(fe=ne,()=>{var e=g/40;se(0,g,e).map(e=>{var a=z.x+m(e)*R,e=z.y+h(e)*S;k(a,e,fe)})})},{from:500,types:[v,y],rate:.3},{from:550,types:[v,y],rate:.25},{from:600,types:[v,y,oe],rate:.25},{from:650,types:[v,y],ee:t,rate:.4},{from:700,types:[v,y,oe],rate:.25,te:pe(y)},{from:720,types:[],rate:0,ee:o}],ie=(e,a,t)=>({x:e,y:a,type:t,health:t.health,P:0,k:0,R:0,u:0,ee:!!t.ee}),k=(e,a,t)=>N.push(ie(e,a,t)),N=[],O=[];function de(e,a,t){var r,n=[["Base damage",l(z.v.damage.value)],["Attack speed",l(z.v.attackSpeed.value,2)],["Health",D(z.v.health.value)],["Regeneration",l(z.v.healthRegen.value,2)+"/s"],["Speed",l(z.v.speed.value,2)],["Health Drop",l(100*z.v.healthDrop.value)+"%"]];for(r of z.U){var o=r.type.name;n.push([o+" level",r.level+1],...r.type.A(r,r.type.m[r.level]))}q(e,a,t,s-a-20,n)}function ce(e,a,t){var r;for(r of[["Survived",G(I.runtime)],["Level",""+(z.level+1)],["Damage",l(I.S)],["DPS",""+l(I.S/I.runtime,2)],["Kills",""+I._]])i.text(e+t/2-5,a,r[0],"#ccc","right"),i.text(e+t/2+5,a,r[1],"#fff","left"),a+=15;return a}function me(){if(I.state!==B.F&&(i.rect(50,0,w-50,20,"#600"),i.rect(50,0,z.health/z.v.health.value*(w-50),20,"#f66"),i.text(52,10,D(z.health)+"/"+D(z.v.health.value),"#fff","left","middle"),i.rect(50,20,w-50,12,"#999"),i.rect(50,20,z.M/z.H*(w-50),12,"#fff"),i.text(52,27,z.M+"/"+z.H,"#000","left","middle"),i.rect(0,0,50,32,"#000"),i.text(25,2,"level","#666","center","top"),i.text(25,18,""+(z.level+1),"#fff","center","top"),i.text(R,35,G(I.runtime),"#fff","center"),I.runtime<20)){let e=s-30-15*L.length;for(var a of L)i.text(10,e,a,"#fff","left","top"),e+=15}switch(I.state){case B.V:i.t(),i.text(R,100,"YOU'RE DEAD!","#f88","center","top",24),e=ce(50,145,w-100),e+=30,i.text(R,e,W,"#fff","center");break;case B.j:i.t(),i.text(R,10,"LEVEL UP","#fff","center","top");for(let e=0;e<I.G.length;e++){let a=I.G[e];var t=z.G.filter(e=>e===a).length,r=50+50*e;d.textAlign="left",d.textBaseline="top",d.fillStyle=e===I.Z?"#333":"#222",d.fillRect(20,r,w-40,40),d.strokeStyle=e===I.Z?"#aa3":"#444",d.strokeRect(20,r,w-40,40),d.fillStyle="#fff",d.fillText(a.name,25,5+r),d.fillStyle="#ccc",d.fillText("function"==typeof a.description?a.description():a.description,25,22+r),i.text(20+w-50,20+r,t+"/"+a.N,"#ccc","right","middle")}de(20,210,w-40);break;case B.q:i.t(),i.text(R,100,"PAUSED","#fff","center","middle"),de(20,110,w-40);break;case B.WIN:i.t(),i.text(R,100,"YOU WON","#fff","center","middle");var e=ce(100,130,w-200);e+=30,i.text(R,e,W,"#fff","center");break;case B.F:i.t(),i.text(R,S-40,"MICRO","#fff","center","bottom",68),i.text(R,S-40,"SURVIVORS","#fff","center","top",38),i.text(R,s-5,"by Kamen","#ccc","center","bottom",10),d.globalAlpha=.5+.5*(.5*m(performance.now()/1e3*5)+.5),i.text(R,S+50,K,"#fff","center"),d.globalAlpha=1}}function he(){d.reset(),d.clearRect(0,0,p.width,p.height),d.translate(-z.x+R,-z.y+S);var e,a,t,r=50*D((z.x-R)/50),n=50*D((z.y-S)/50),o=50*$((z.x+R)/50),s=50*$((z.y+S)/50);for(let a=r;a<o;a+=50)for(let e=n;e<s;e+=50)i.rect(a,e,50,50,a%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000");for(e of O)i.o(e.x-3,e.y-3,10<=(e.M??0)?8:6,0<(e.health??0)?"#0c0":(e.M??0)<10?"#05f":"#ff0");for(a of z.U)a.type.D(a,a.type.m[a.level]);i.rect(z.x-5,z.y-5,10,10,"#fff");for(t of N){var f=t.type;f.D(t.x,t.y,0<t.u?"#fff":void 0),f.ee&&(i.rect(t.x-20,t.y+15,40,3,"#333"),i.rect(t.x-20,t.y+15,t.health/f.health*40,3,"#f33"))}d.resetTransform(),0<(r=C(1,z.W/.5))&&(r=F(80,"#ff000000",`rgba(255,0,0,${r})`),i.t(r)),0<(r=C(1,z.Y/.1))&&(r=F(130,"#ffffff00",`rgba(255,255,255,${.15*r})`),i.t(r)),me()}function ge(n){var e,a=n;switch(I.state){case B.RUNNING:I.runtime+=a,U.pause&&(I.state=B.q),z.health<=0&&(I.state=B.V);var t=le.findIndex(e=>e.from>I.runtime)-1,r=le[t<0?le.length-1:t];-2==t&&0===N.length&&(I.state=B.WIN),r&&(t!==I.X&&(I.X=t,r.ee&&ve(r.ee),r.te?.()),I.J>r.rate?(0<r.types.length&&ve(j(r.types)),I.J=0):I.J+=a);break;case B.WIN:case B.V:case B.F:P.enter&&(Object.assign(z,ae(Q)),Object.assign(I,te),I.state=B.RUNNING,N.length=0,O.length=0);break;case B.j:U.up&&0<I.Z&&I.Z--,U.down&&I.Z<I.G.length-1&&I.Z++,U.enter&&((t=I.G[I.Z]).apply(z),z.G.push(t),I.state=B.RUNNING);break;case B.q:(U.pause||U.enter)&&(I.state=B.RUNNING)}if(I.state===B.RUNNING){{var o,s=n;let t=0,r=[];for(o of N){var f=o.type;if(o.health<=0)O.push({x:o.x,y:o.y,M:f.M}),A()<z.v.healthDrop.value&&O.push({x:o.x-5+10*A(),y:o.y-5+10*A(),health:10}),I._+=1,r.push(t);else{0<o.u&&(o.u-=s);let e=o.k*s,a=o.R*s;var p,l=z.x-o.x,i=z.y-o.y,d=E(l,i);!o.ee&&3*w<d?r.push(t):(o.P<=0?(d<o.type.size-2&&(z.health-=f.health,z.W=.5,o.P=f.P),p=f.speed*s,e+=l/d*p,a+=i/d*p):o.P-=s,o.x+=e,o.y+=a,!(.1<T(o.k))||(l=(0<o.k?-1:1)*s*(f.ae??20),T(l)>T(o.k))?o.k=0:o.k+=l,!(.1<T(o.R))||(i=(0<o.R?-1:1)*s*(f.ae??20),T(i)>T(o.R))?o.R=0:o.R+=i)}t++}let a=0;for(let e of r)N.splice(e-a,1),a+=1}{var c,m=n;let e=0,a=[];for(c of O){var h,g=z.x-c.x,v=z.y-c.y,u=E(g,v);u<10?(z.health=C(z.v.health.value,z.health+(c.health??0)),z.M+=c.M??0,z.Y=.1,a.push(e)):u<z.v.pickupDistance.value&&(h=(z.v.pickupDistance.value+10-u)*m*2,c.x+=g/u*h,c.y+=v/u*h),e++}let t=0;for(let e of a)O.splice(e-t,1),t+=1}{var y=n;let e=0,a=0;P.up&&--a,P.down&&(a+=1),P.left&&--e,P.right&&(e+=1);var b,k,n=z.v.speed.value*y,x=E(e,a);0<x&&(z.x+=e/x*n,z.y+=a/x*n),x=R,n=S,z.T=H(P.targetY-n,P.targetX-x),z.M>=z.H&&(z.level+=1,z.M-=z.H,z.H+=10,n=Z.filter(a=>!(a.O&&!a.O(z)||a.N&&z.G.filter(e=>e===a).length>=a.N)),I.G=(a=>{for(let e=a.length-1;0<=e;e--){var t=D(A()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a})(n).slice(0,3),0<I.G.length&&(I.state=B.j),z.health+=5),0<z.W&&(z.W-=y),0<z.Y&&(z.Y-=y),z.health=C(z.v.health.value,z.health+z.v.healthRegen.value*y);for(b of z.U)b.g+=y,b.P<=0?(k=b.type.m[b.level],b.type.g(b,k),b.P=k.h*z.v.attackSpeed.value):b.P-=y}}for(e in U)U[e]=!1}function ve(e){var a=A()*g,t=Math.max(w,s)/2,t=E(t,t)+15*A();N.push(ie(z.x+m(a)*t,z.y+h(a)*t,e))}let ue=0;return x.appendChild(p),requestAnimationFrame(function e(a){requestAnimationFrame(e);var t=(a-ue)/1e3;ue=a,he(),ge(t)}),[z,I]}