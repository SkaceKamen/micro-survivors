function microSurvivors(m=document.body,I=400,p=400){let h=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],L=I/2,N=p/2,{floor:M,ceil:x,random:W,round:g,cos:$,sin:O,min:H,hypot:K,abs:Y,atan2:Z,PI:u}=Math,G=2*u;var e="Press ENTER to ";let v=e+"start",w=e+"restart",S=(e,a=2,r="0")=>e.toString().padStart(a,r);function R(e){var a=M(e/60),e=M(e%60);return S(a)+":"+S(e)}let D=e=>l(e*(180/u)),l=(e,a=0)=>e.toFixed(a),ee=(e,a,r,t)=>K(r-e,t-a);let ae=e=>e[g(W()*(e.length-1))],y={rect(e,a,r,t,n){k.fillStyle=n,k.fillRect(e,a,r,t)},t(e="#000000e5"){k.fillStyle=e,k.fillRect(0,0,I,p)},o(e,a,r,t){k.fillStyle=t,k.fillRect(e-r/2,a-r/2,r,r)},l(e,a,r,t){k.fillStyle=t,k.beginPath(),k.moveTo(e,a-r/2),k.lineTo(e-r/2,a+r/2),k.lineTo(e+r/2,a+r/2),k.fill()},text(e,a,r,t,n="left",s="top",o=14){k.font=o+"px monospace",k.fillStyle=t,k.textAlign=n,k.textBaseline=s,k.fillText(r,e,a)},i(e,a,r,t){k.fillStyle=t,k.beginPath(),k.arc(e,a,r,0,G),k.fill()}},E=(e,a,r,t,n)=>{var s,o,f=a,p=r/2;15*n.length<t&&(e+=r/4);for([s,o]of n)y.text(e,a,s+":","#aaa"),y.text(e+p-5,a,""+o,"#fff","right"),f+t<(a+=15)&&(a=f,e+=p)},A=(e,a,r)=>{e=k.createRadialGradient(L,N,e,L,N,L);return e.addColorStop(0,a),e.addColorStop(1,r),e},b=document.createElement("canvas"),k=(b.width=I,b.height=p,b.getContext("2d")??(()=>{throw new Error})()),C={arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",w:"up",s:"down",a:"left",d:"right",enter:"enter",escape:"pause",p:"pause"},V={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},q={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},B=(e,a)=>{e=C[e.key.toLowerCase()];e&&(V[e]=a,q[e]=a)};e="addEventListener";document[e]("keydown",e=>B(e,!0)),document[e]("keyup",e=>B(e,!1)),b[e]("mousemove",e=>{var a=b.getBoundingClientRect();V.targetX=e.clientX-a.left,V.targetY=e.clientY-a.top});let F={m:0,h:1,g:2};var e=a=>{let r=a[0];var t=[a[0]];for(let e=1;e<a.length;e++)r={...r,...a[e]},t[e]=r;return t},a={name:"Saw Blades",type:F.m,v:e([{damage:5,range:50,rotationSpeed:u/2,u:.1,blades:1,size:10},{blades:2},{damage:10,rotationSpeed:u/1.5},{rotationSpeed:u/1.25,size:15},{blades:3},{damage:15},{blades:4}])},r={name:"Sword",type:F.h,v:e([{damage:8,angle:u/4,range:80,k:.5},{damage:13},{angle:u/4*1.2,range:90},{damage:18},{damage:23},{damage:28,angle:u/4*1.5},{damage:33,angle:u/4*1.7,range:120}])},e={name:"Barbed Wire",type:F.g,v:e([{range:40,damage:2,k:.75},{range:60},{damage:3},{range:70},{range:80},{damage:4}])};let T=e=>({type:e,S:0,R:0,level:0});var t=e=>()=>X.level*e;let re={D:[r],A:{health:[100,t(10)],speed:[45,t(.2)],healthRegen:[.1,t(.025)],pickupDistance:[50],damage:[t(.3)],attackSpeed:[1],healthDrop:[.01]}};var t=(a,r)=>e=>e.A[a].base.push(r),n=(a,r)=>e=>e.A[a].base.push(r),s=(f,e)=>{let p;return{name:e,description:()=>{var e=p?.C??X.D.find(e=>e.type===f);if(!e)return"New weapon";if(p?.level===e.level)return p.B;var a,r,t=e.type.v[e.level],n=e.type.v[e.level+1],s=[];for(a in n)n[a]!==t[a]&&(r=n[a]-t[a],r="angle"===a?D(r)+"°":l(r),s.push(`+${r} `+a));var o=s.join(", ");return p={level:e.level,C:e,B:o},o},apply:e=>{var a=e.D.find(e=>e.type===f);a?a.level++:e.D.push(T(f))},T:f.v.length}};let te=[{name:"Speed boost",description:"+25% speed",apply:n("speed",1.25),T:5},{name:"Speed base",description:"+1 base speed",apply:t("speed",1),T:5},{name:"Heal",description:"+25 health",P:e=>e.health+25<e.A.health.value,apply:e=>e.health+=25,T:5},{name:"Max health",description:"+25 max health, +5 health",apply:e=>{e.A.health.base.push(25),e.health+=5},T:5},{name:"Health drop",description:"+1% health drop chance",apply:t("healthDrop",.01),T:5},{name:"Regen",description:"+0.1/s health regen",apply:t("healthRegen",.1),T:5},{name:"Regen boost",description:"+10% health regen",apply:n("healthRegen",1.1),T:5},{name:"Pickup range",description:"+10 pickup range",apply:t("pickupDistance",10),T:5},{name:"Damage",description:"+1 damage",apply:t("damage",1),T:5},{name:"Attack speed",description:"+5% attack speed",apply:t("attackSpeed",-.05),T:5},s(a,"Saw Blades"),s(r,"Sword"),s(e,"Barbed Wire")],P=e=>"function"==typeof e?e():e,o=(e=[],a=[])=>({base:[...e],multiplier:[...a],U:null,get value(){var e;return this.U?.base===this.base&&this.U?.multiplier===this.multiplier&&this.U?.I===X.level?this.U.value:(e=this.base.reduce(e=(e,a)=>e+P(a),0)*this.multiplier.reduce(e,1),this.U={base:this.base,multiplier:this.multiplier,I:X.level,value:e},e)}}),ne=e=>({type:e,x:0,y:0,level:0,L:0,N:5,health:100,M:0,W:0,$:0,O:0,A:{speed:o(e.A.speed),health:o(e.A.health),healthRegen:o(e.A.healthRegen),pickupDistance:o(e.A.pickupDistance),damage:o(e.A.damage),attackSpeed:o(e.A.attackSpeed),healthDrop:o(e.A.healthDrop)},H:[],D:e.D.map(e=>T(e))}),X=ne(re),_={RUNNING:0,K:1,Y:2,G:3,WIN:4,V:5},se={q:-1,runtime:0,F:0,X:0,_:0,H:[],j:0},j={state:_.V,...se};var n=e=>({...e,R:1,size:10}),t=(e,s)=>(r,t,n)=>e.map((e,a)=>y.o(r+a,t+a,s,n??e)),a=(e,s)=>(r,t,n)=>e.map((e,a)=>y.l(r+a,t+a,s,n??e)),r=(e,s)=>(r,t,n)=>e.map((e,a)=>y.i(r+a,t+a,s,n??e)),s=n({health:10,speed:26,damage:1,L:1,J:t(["#aaa"],10)}),e=n({health:50,speed:26,damage:1,L:2,J:t(["#aaa","#faa"],10)}),f=n({health:100,speed:30,damage:2,L:3,J:t(["#aaa","#faa","#4a4"],10)}),t=n({health:500,speed:30,damage:10,L:20,size:20,J:t(["#faa"],20),Z:!0}),i=n({health:20,speed:35,damage:2,L:2,J:a(["#999"],10)}),U=n({health:40,speed:35,damage:2,L:3,J:a(["#999","#0ac"],10)}),c=n({health:60,speed:35,damage:3,L:4,J:a(["#999","#0ac","#966"],10)}),a=n({health:1e3,speed:35,damage:10,L:50,Z:!0,ee:80,size:20,J:a(["#faa"],20)}),z=n({health:10,speed:40,damage:1,L:3,J:r(["#999"],5)}),oe=n({health:20,speed:40,damage:1,L:4,J:r(["#999","#0ac"],5)}),fe=n({health:50,speed:40,damage:1,L:5,J:r(["#999","#0ac","#4ca"],5)}),r=n({health:1e3,speed:40,damage:5,L:4,Z:!0,ee:80,size:16,J:r(["#faa"],8)}),n=n({health:1e4,speed:55,damage:5,L:0,Z:!0,ee:1e3,size:50,J(e,a,r){y.i(e,a,25,r??"#faa"),y.o(e,a,25,r??"#0ac"),y.l(e,a,23,r??"#faa")}});let pe=(r,e,t=1)=>Array.from({length:M((e-r)/t)}).map((e,a)=>a*t+r);var le,ie=r=>()=>{var e=pe(X.x-L,X.x+L,2*r.size),a=pe(X.y-N,X.y+N,2*r.size);e.map(e=>d(e,X.y-N,r)),e.map(e=>d(e,X.y+N,r)),a.map(e=>d(X.x-L,e,r)),a.map(e=>d(X.x+L,e,r))};let ce=[{from:0,types:[s],rate:.4},{from:30,types:[s,i],rate:.5},{from:80,types:[s,i],rate:.4},{from:120,types:[i],rate:.3,Z:t},{from:150,types:[i,z],rate:.4},{from:200,types:[i,z],rate:.3},{from:250,types:[e],rate:.3,ae:ie(e)},{from:300,types:[e,U,z],rate:.3},{from:330,types:[U,z],Z:a,rate:.3},{from:380,types:[U,oe,e],rate:.3},{from:450,types:[oe,f],rate:.4,ae:(le=oe,()=>{var e=G/40;pe(0,G,e).map(e=>{var a=X.x+$(e)*L,e=X.y+O(e)*N;d(a,e,le)})})},{from:500,types:[f,c],rate:.3},{from:550,types:[f,c],rate:.25},{from:600,types:[f,c,fe],rate:.25},{from:650,types:[f,c],Z:r,rate:.4},{from:700,types:[f,c,fe],rate:.25,ae:ie(c)},{from:720,types:[],rate:0,Z:n}],de=(e,a,r)=>({x:e,y:a,type:r,health:r.health,R:0,re:0,te:0,ne:0,Z:!!r.Z}),d=(e,a,r)=>J.push(de(e,a,r)),J=[],Q=[];function me(e,a,r){var t,n=[["Base damage",l(X.A.damage.value)],["Attack speed",l(X.A.attackSpeed.value,2)],["Health",M(X.A.health.value)],["Regeneration",l(X.A.healthRegen.value,2)+"/s"],["Speed",l(X.A.speed.value,2)],["Health Drop",l(100*X.A.healthDrop.value)+"%"]];for(t of X.D){var s=t.type.name;switch(t.type.type){case F.h:var o=t.type.v[t.level];n.push([s+" level",t.level+1]),n.push([s+" damage",l(o.damage)]),n.push([s+" range",l(o.range)]),n.push([s+" angle",D(o.angle)+"°"]);break;case F.m:o=t.type.v[t.level];n.push([s+" level",t.level+1]),n.push([s+" damage",l(o.damage)]),n.push([s+" range",l(o.range)]),n.push([s+" blades",l(o.blades)]),n.push([s+" size",l(o.size)]);break;case F.g:var f=t.type.v[t.level];n.push([s+" level",t.level+1]),n.push([s+" damage",l(f.damage)]),n.push([s+" range",l(f.range)])}}E(e,a,r,p-a-20,n)}function he(e,a,r){var t;for(t of[["Survived",R(j.runtime)],["Level",""+(X.level+1)],["Damage",l(j.F)],["DPS",""+l(j.F/j.runtime,2)],["Kills",""+j.X]])y.text(e+r/2-5,a,t[0],"#ccc","right"),y.text(e+r/2+5,a,t[1],"#fff","left"),a+=15;return a}function ge(){if(j.state!==_.V&&(y.rect(50,0,I-50,20,"#600"),y.rect(50,0,X.health/X.A.health.value*(I-50),20,"#f66"),y.text(52,10,M(X.health)+" / "+M(X.A.health.value),"#fff","left","middle"),y.rect(50,20,I-50,12,"#999"),y.rect(50,20,X.L/X.N*(I-50),12,"#fff"),y.text(52,27,X.L+" / "+X.N,"#000","left","middle"),y.rect(0,0,50,32,"#000"),y.text(25,2,"level","#666","center","top"),y.text(25,18,""+(X.level+1),"#fff","center","top"),y.text(L,35,R(j.runtime),"#fff","center"),j.runtime<20)){let e=p-30-15*h.length;for(var a of h)y.text(10,e,a,"#fff","left","top"),e+=15}switch(j.state){case _.K:y.t(),y.text(L,100,"YOU'RE DEAD!","#f88","center","top",24),e=he(50,145,I-100),e+=30,y.text(L,e,w,"#fff","center");break;case _.Y:y.t(),y.text(L,10,"LEVEL UP","#fff","center","top");for(let e=0;e<j.H.length;e++){let a=j.H[e];var r=X.H.filter(e=>e===a).length,t=50+50*e;k.textAlign="left",k.textBaseline="top",k.fillStyle=e===j.j?"#333":"#222",k.fillRect(20,t,I-40,40),k.strokeStyle=e===j.j?"#aa3":"#444",k.strokeRect(20,t,I-40,40),k.fillStyle="#fff",k.fillText(a.name,25,5+t),k.fillStyle="#ccc",k.fillText("function"==typeof a.description?a.description():a.description,25,22+t),y.text(20+I-50,20+t,r+"/"+a.T,"#ccc","right","middle")}me(20,210,I-40);break;case _.G:y.t(),y.text(L,100,"PAUSED","#fff","center","middle"),me(20,110,I-40);break;case _.WIN:y.t(),y.text(L,100,"YOU WON","#fff","center","middle");var e=he(100,130,I-200);e+=30,y.text(L,e,w,"#fff","center");break;case _.V:y.t(),y.text(L,N-40,"MICRO","#fff","center","bottom",68),y.text(L,N-40,"SURVIVORS","#fff","center","top",38),y.text(L,p-5,"by Kamen","#ccc","center","bottom",10),k.globalAlpha=.5+.5*(.5*$(performance.now()/1e3*5)+.5),y.text(L,N+50,v,"#fff","center"),k.globalAlpha=1}}function ve(){k.reset(),k.clearRect(0,0,b.width,b.height),k.translate(-X.x+L,-X.y+N);var e,a,r,t=50*M((X.x-L)/50),n=50*M((X.y-N)/50),s=50*x((X.x+L)/50),o=50*x((X.y+N)/50);for(let a=t;a<s;a+=50)for(let e=n;e<o;e+=50)y.rect(a,e,50,50,a%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000");for(e of Q)y.o(e.x-3,e.y-3,10<=(e.L??0)?8:6,0<(e.health??0)?"#0c0":(e.L??0)<10?"#05f":"#ff0");for(a of X.D)switch(a.type.type){case F.m:var f=a.type.v[a.level],p=G/f.blades,l=a.S*f.rotationSpeed;for(let e=0;e<f.blades;e++){var i=l+p*e,c=X.x+$(i)*f.range,i=X.y+O(i)*f.range;y.i(c,i,f.size/2,"#fff")}break;case F.h:var d=a.type.v[a.level],m=d.k*X.A.attackSpeed.value,m=.2*(a.R/m);0<m&&(h=d.angle/2,k.fillStyle=`rgba(255,255,255,${m})`,k.beginPath(),k.moveTo(X.x,X.y),k.lineTo(X.x+$(X.O-h)*d.range,X.y+O(X.O-h)*d.range),k.arc(X.x,X.y,d.range,X.O-h,X.O+h),k.lineTo(X.x,X.y),k.fill());break;case F.g:var m=a.type.v[a.level],d=m.k*X.A.attackSpeed.value,h=a.R/d,g=.15+.02*$(2*h*u);y.i(X.x,X.y,m.range,`rgba(255,0,0,${g})`)}y.rect(X.x-5,X.y-5,10,10,"#fff");for(r of J){var v=r.type;v.J(r.x,r.y,0<r.ne?"#fff":void 0),v.Z&&(y.rect(r.x-20,r.y+15,40,3,"#333"),y.rect(r.x-20,r.y+15,r.health/v.health*40,3,"#f33"))}k.resetTransform(),0<(t=H(1,X.W/.5))&&(t=A(80,"#ff000000",`rgba(255,0,0,${t})`),y.t(t)),0<(t=H(1,X.$/.1))&&(t=A(130,"#ffffff00",`rgba(255,255,255,${.15*t})`),y.t(t)),ge()}function ue(n){var e,a,r,t=n;switch(j.state){case _.RUNNING:(j.runtime+=t,q.pause)?j.state=_.G:X.health<=0?j.state=_.K:(a=ce.findIndex(e=>e.from>j.runtime)-1,e=ce[a<0?ce.length-1:a],-2==a&&0===J.length&&(j.state=_.WIN),e&&(a!==j.q&&(j.q=a,e.Z&&ye(e.Z),e.ae?.()),j._>e.rate?(0<e.types.length&&ye(ae(e.types)),j._=0):j._+=t));break;case _.WIN:case _.K:case _.V:V.enter&&(()=>{var e,a,r=ne(re);for(e in X)X[e]=r[e];for(a in se)j[a]=se[a];j.state=_.RUNNING,J.length=0,Q.length=0})();break;case _.Y:q.up&&0<j.j&&j.j--,q.down&&j.j<j.H.length-1&&j.j++,q.enter&&((a=j.H[j.j]).apply(X),X.H.push(a),j.state=_.RUNNING);break;case _.G:(q.pause||q.enter)&&(j.state=_.RUNNING)}if(j.state===_.RUNNING){{var s,o=n;let r=0,t=[];for(s of J){var f=s.type;if(s.health<=0)Q.push({x:s.x,y:s.y,L:f.L}),W()<X.A.healthDrop.value&&Q.push({x:s.x-5+10*W(),y:s.y-5+10*W(),health:10}),j.X+=1,t.push(r);else{0<s.ne&&(s.ne-=o);let e=s.re*o,a=s.te*o;var p,l=X.x-s.x,i=X.y-s.y,c=K(l,i);!s.Z&&3*I<c?t.push(r):(s.R<=0?(c<s.type.size-2&&(X.health-=f.health,X.W=.5,s.R=f.R),p=f.speed*o,e+=l/c*p,a+=i/c*p):s.R-=o,s.x+=e,s.y+=a,!(.1<Y(s.re))||(l=(0<s.re?-1:1)*o*(f.ee??20),Y(l)>Y(s.re))?s.re=0:s.re+=l,!(.1<Y(s.te))||(i=(0<s.te?-1:1)*o*(f.ee??20),Y(i)>Y(s.te))?s.te=0:s.te+=i)}r++}let a=0;for(let e of t)J.splice(e-a,1),a+=1}{var d,m=n;let e=0,a=[];for(d of Q){var h,g=X.x-d.x,v=X.y-d.y,u=K(g,v);u<10?(X.health=H(X.A.health.value,X.health+(d.health??0)),X.L+=d.L??0,X.$=.1,a.push(e)):u<X.A.pickupDistance.value&&(h=(X.A.pickupDistance.value+10-u)*m*2,d.x+=g/u*h,d.y+=v/u*h),e++}let r=0;for(let e of a)Q.splice(e-r,1),r+=1}{var y=n;let e=0,a=0;V.up&&--a,V.down&&(a+=1),V.left&&--e,V.right&&(e+=1);var b,n=X.A.speed.value*y,k=K(e,a);0<k&&(X.x+=e/k*n,X.y+=a/k*n),k=L,n=N,X.O=Z(V.targetY-n,V.targetX-k),X.L>=X.N&&(X.level+=1,X.L-=X.N,X.N+=10,n=te.filter(a=>!(a.P&&!a.P(X)||a.T&&X.H.filter(e=>e===a).length>=a.T)),j.H=(a=>{for(let e=a.length-1;0<=e;e--){var r=M(W()*(e+1));[a[e],a[r]]=[a[r],a[e]]}return a})(n).slice(0,3),0<j.H.length&&(j.state=_.Y),X.health+=5),0<X.W&&(X.W-=y),0<X.$&&(X.$-=y),X.health=H(X.A.health.value,X.health+X.A.healthRegen.value*y);for(b of X.D)switch(b.S+=y,b.type.type){case F.m:var x=b.type.v[b.level],w=x.damage+X.A.damage.value;if(b.R<=0){b.R=x.u*X.A.attackSpeed.value;var S=G/x.blades,R=b.S*x.rotationSpeed;for(let e=0;e<x.blades;e++){var D,E=R+S*e,A=X.x+$(E)*x.range,C=X.y+O(E)*x.range;for(D of J)ee(D.x,D.y,A,C)<x.size/2+D.type.size+2&&(D.health-=w,D.ne=.1,D.re=20*$(E),D.te=20*O(E),j.F+=w)}}else b.R-=y;break;case F.h:0<b.R?b.R-=y:(((e,a)=>{var r,t=a.v[e.level],n=t.damage+X.A.damage.value,a=t.angle/2,s=X.O-a,o=X.O+a;for(r of J){var f=r.x-X.x,p=r.y-X.y,l=Z(p,f),f=K(f,p),p=Z(r.type.size/2,f);s<l+p&&l-p<o&&f-r.type.size/2<t.range&&(r.health-=n,r.ne=.1,r.re=25*$(l),r.te=25*O(l),j.F+=n)}})(b,b.type),b.R=b.type.v[b.level].k*X.A.attackSpeed.value);break;case F.g:if(0<b.R)b.R-=y;else{var B,T=b.type.v[b.level],P=T.damage+X.A.damage.value;for(B of J){var U=B.x-X.x,z=B.y-X.y;let e=K(U,z);e<T.range&&(B.health-=P,B.ne=.1,j.F+=P)}b.R=b.type.v[b.level].k*X.A.attackSpeed.value}}}}for(r in q)q[r]=!1}function ye(e){var a=W()*G,r=Math.max(I,p)/2,r=K(r,r)+15*W();J.push(de(X.x+$(a)*r,X.y+O(a)*r,e))}let be=0;return m.appendChild(b),requestAnimationFrame(function e(a){requestAnimationFrame(e);var r=(a-be)/1e3;be=a,ve(),ue(r)}),[X,j]}