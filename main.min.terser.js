function microSurvivors(e=document.body,a=400,t=400){const s=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],n=a/2,r=t/2,{floor:o,ceil:c,random:f,round:p,cos:i,sin:d,min:l,hypot:m,abs:h,atan2:g,PI:u}=Math,y=2*u,b="Press ENTER to ",x=b+"start",k=b+"restart",v="center",w="top",S="left",R="right",$="middle",D="addEventListener",C=(e,a=2,t="0")=>e.toString().padStart(a,t),E=e=>C(o(e/60))+":"+C(o(e%60)),A=e=>T(e*(180/u))+"Â°",T=(e,a=0)=>e.toFixed(a),z=(e,a,t,s)=>m(t-e,s-a),B={rect(e,a,t,s,n,r){L[r?"strokeStyle":"fillStyle"]=n,L[r?"strokeRect":"fillRect"](e,a,t,s)},t(e="#000000e5"){L.fillStyle=e,L.fillRect(0,0,a,t)},o(e,a,t,s){L.fillStyle=s,L.fillRect(e-t/2,a-t/2,t,t)},i(e,a,t,s){L.fillStyle=s,L.beginPath(),L.moveTo(e,a-t/2),L.lineTo(e-t/2,a+t/2),L.lineTo(e+t/2,a+t/2),L.fill()},text(e,a,t,s,n=S,r=w,o=14){L.font=`${o}px monospace`,L.fillStyle=s,L.textAlign=n,L.textBaseline=r,L.fillText(t,e,a)},l(e,a,t,s){L.fillStyle=s,L.beginPath(),L.arc(e,a,t,0,y),L.fill()}},O=(e,a,t)=>{const s=L.createRadialGradient(n,r,e,n,r,n);return s.addColorStop(0,a),s.addColorStop(1,t),s},P=document.createElement("canvas");P.width=a,P.height=t;const L=P.getContext("2d")??(()=>{throw new Error})(),U={arrowup:"up",arrowdown:"down",arrowleft:S,arrowright:R,w:"up",s:"down",a:S,d:R,enter:"enter",escape:"pause",p:"pause"},M={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},H={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},I=(e,a)=>{const t=U[e.key.toLowerCase()];t&&(M[t]=a,H[t]=a)};document[D]("keydown",(e=>I(e,!0))),document[D]("keyup",(e=>I(e,!1))),P[D]("mousemove",(e=>{const a=P.getBoundingClientRect();M.targetX=e.clientX-a.left,M.targetY=e.clientY-a.top}));const Y=e=>{let a=e[0],t=[e[0]];return e.forEach(((e,s)=>{a={...a,...e},t[s]=a})),t},K={name:"Saw Blades",m:Y([{damage:5,range:50,rotationSpeed:u/2,h:.1,blades:1,size:10},{blades:2},{damage:10,rotationSpeed:u/1.5},{rotationSpeed:u/1.25,size:15},{blades:3},{damage:15},{blades:4}]),u(e,a){const t=a.damage+_.k.damage.value,s=y/a.blades,n=e.u*a.rotationSpeed;for(let e=0;e<a.blades;e++){const r=n+s*e,o=_.x+i(r)*a.range,c=_.y+d(r)*a.range;for(const e of ze){z(e.x,e.y,o,c)<a.size/2+e.type.size+2&&(e.health-=t,e.v=.1,e.S=20*i(r),e.R=20*d(r),ce.$+=t)}}},D(e,a){const t=y/a.blades,s=e.u*a.rotationSpeed;for(let e=0;e<a.blades;e++){const n=s+t*e,r=_.x+i(n)*a.range,o=_.y+d(n)*a.range;B.l(r,o,a.size/2,"#fff")}},stats:(e,a)=>[["damage",T(a.damage)],["range",T(a.range)],["speed",A(a.rotationSpeed)+"/s"],["blades",T(a.blades)],["size",T(a.size)]]},N={name:"Sword",m:Y([{damage:8,angle:u/4,range:80,h:.5},{damage:13},{angle:u/4*1.2,range:90},{damage:18},{damage:23},{damage:28,angle:u/4*1.5},{damage:33,angle:u/4*1.7,range:120}]),u(e,a){const t=a.damage+_.k.damage.value,s=a.angle/2,n=_.C-s,r=_.C+s;for(const e of ze){const s=e.x-_.x,o=e.y-_.y,c=g(o,s),f=m(s,o),p=g(e.type.size/2,f);c+p>n&&c-p<r&&f-e.type.size/2<a.range&&(e.health-=t,e.v=.1,e.S=25*i(c),e.R=25*d(c),ce.$+=t)}},D(e,a){const t=a.h*_.k.attackSpeed.value,s=.2*(e.A/t);if(s>0){const e=a.angle/2;L.fillStyle=`rgba(255,255,255,${s})`,L.beginPath(),L.moveTo(_.x,_.y),L.lineTo(_.x+i(_.C-e)*a.range,_.y+d(_.C-e)*a.range),L.arc(_.x,_.y,a.range,_.C-e,_.C+e),L.lineTo(_.x,_.y),L.fill()}},stats:(e,a)=>[["damage",T(a.damage)],["range",T(a.range)],["angle",A(a.angle)]]},V={name:"Barbed Wire",m:Y([{range:40,damage:2,h:.75},{range:60},{damage:3},{range:70},{range:80},{damage:4}]),u(e,a){const t=a.damage+_.k.damage.value;for(const e of ze){z(_.x,_.y,e.x,e.y)<a.range&&(e.health-=t,e.v=.1,ce.$+=t)}},D(e,a){const t=a.h*_.k.attackSpeed.value,s=e.A/t,n=.15+.02*i(2*s*u);B.l(_.x,_.y,a.range,`rgba(255,0,0,${n})`)},stats:(e,a)=>[["damage",T(a.damage)],["range",T(a.range)]]},W=e=>({type:e,u:0,A:0,level:0}),j=e=>()=>_.level*e,q={T:[N],k:{health:[100,j(10)],speed:[45,j(.2)],healthRegen:[.1,j(.025)],pickupDistance:[50],damage:[j(.3)],attackSpeed:[1],healthDrop:[.01]}},F=(e,a)=>()=>_.k[e].base.push(a),X=(e,a)=>()=>_.k[e].base.push(a),G=e=>{let a;return{name:e.name,description(){const t=a?.B??_.T.find((a=>a.type===e));if(!t)return"New weapon";if(a?.level===t.level)return a.O;const s=t.type.m[t.level],n=t.type.m[t.level+1],r=[];for(const e in n)if(n[e]!==s[e]){const a=n[e]-s[e],t="angle"===e?A(a):T(a);r.push(`+${t} ${e}`)}const o=r.join(", ");return a={level:t.level,B:t,O:o},o},apply(){const a=_.T.find((a=>a.type===e));a?a.level++:_.T.push(W(e))},P:e.m.length}},J=[{name:"Speed boost",description:"+25% speed",apply:X("speed",1.25),P:5},{name:"Speed base",description:"+1 base speed",apply:F("speed",1),P:5},{name:"Heal",description:"+25 health",L:()=>_.health+25<_.k.health.value,apply:()=>_.health+=25,P:5},{name:"Max health",description:"+25 max health, +5 health",apply:()=>{_.k.health.base.push(25),_.health+=5},P:5},{name:"Health drop",description:"+1% health drop chance",apply:F("healthDrop",.01),P:5},{name:"Regen",description:"+0.1/s health regen",apply:F("healthRegen",.1),P:5},{name:"Regen boost",description:"+10% health regen",apply:X("healthRegen",1.1),P:5},{name:"Pickup range",description:"+10 pickup range",apply:F("pickupDistance",10),P:5},{name:"Damage",description:"+1 damage",apply:F("damage",1),P:5},{name:"Attack speed",description:"+5% attack speed",apply:F("attackSpeed",-.05),P:5},G(K),G(N),G(V)],Q=(e=[],a=[])=>({base:[...e],multiplier:[...a],U:null,get value(){if(this.U?.base===this.base&&this.U?.multiplier===this.multiplier&&this.U?.M===_.level)return this.U.value;const e=(e,a)=>e+(e=>"function"==typeof e?e():e)(a),a=this.base.reduce(e,0)*this.multiplier.reduce(e,1);return this.U={base:this.base,multiplier:this.multiplier,M:_.level,value:a},a}}),Z=e=>({type:e,x:0,y:0,level:0,H:0,I:5,health:100,Y:0,K:0,N:0,C:0,k:{speed:Q(e.k.speed),health:Q(e.k.health),healthRegen:Q(e.k.healthRegen),pickupDistance:Q(e.k.pickupDistance),damage:Q(e.k.damage),attackSpeed:Q(e.k.attackSpeed),healthDrop:Q(e.k.healthDrop)},V:[],T:e.T.map((e=>W(e)))}),_=Z(q),ee=0,ae=1,te=2,se=3,ne=4,re=5,oe={W:-1,runtime:0,$:0,j:0,q:0,V:[],F:0},ce={state:re,...oe},fe=e=>({...e,A:1,size:10}),pe=(e,a)=>(t,s,n)=>e.map(((e,r)=>B.o(t+r,s+r,a,n??e))),ie=(e,a)=>(t,s,n)=>e.map(((e,r)=>B.i(t+r,s+r,a,n??e))),de=(e,a)=>(t,s,n)=>e.map(((e,r)=>B.l(t+r,s+r,a,n??e))),le=fe({health:10,speed:26,damage:8,H:1,D:pe(["#aaa"],10)}),me=fe({health:50,speed:26,damage:10,H:2,D:pe(["#aaa","#faa"],10)}),he=fe({health:100,speed:30,damage:20,H:3,D:pe(["#aaa","#faa","#4a4"],10)}),ge=fe({health:500,speed:30,damage:20,H:20,size:20,D:pe(["#faa"],20),X:!0}),ue=fe({health:20,speed:35,damage:10,H:2,D:ie(["#999"],10)}),ye=fe({health:40,speed:35,damage:20,H:3,D:ie(["#999","#0ac"],10)}),be=fe({health:60,speed:35,damage:30,H:4,D:ie(["#999","#0ac","#966"],10)}),xe=fe({health:1e3,speed:35,damage:30,H:50,X:!0,G:80,size:20,D:ie(["#faa"],20)}),ke=fe({health:10,speed:40,damage:8,H:3,D:de(["#999"],5)}),ve=fe({health:20,speed:40,damage:10,H:4,D:de(["#999","#0ac"],5)}),we=fe({health:50,speed:40,damage:20,H:5,D:de(["#999","#0ac","#4ca"],5)}),Se=fe({health:1e3,speed:40,damage:20,H:4,X:!0,G:80,size:16,D:de(["#faa"],8)}),Re=fe({health:1e4,speed:55,damage:50,H:0,X:!0,G:1e3,size:50,D(e,a,t){B.l(e,a,25,t??"#faa"),B.o(e,a,25,t??"#0ac"),B.i(e,a,23,t??"#faa")}}),$e=(e,a,t=1)=>Array.from({length:o((a-e)/t)}).map(((a,s)=>s*t+e)),De=e=>()=>{const a=$e(_.x-n,_.x+n,2*e.size),t=$e(_.y-r,_.y+r,2*e.size);a.map((a=>Te(a,_.y-r,e))),a.map((a=>Te(a,_.y+r,e))),t.map((a=>Te(_.x-n,a,e))),t.map((a=>Te(_.x+n,a,e)))},Ce=[{from:0,types:[le],rate:.4},{from:30,types:[le,ue],rate:.5},{from:80,types:[le,ue],rate:.4},{from:120,types:[ue],rate:.3,X:ge},{from:150,types:[ue,ke],rate:.4},{from:200,types:[ue,ke],rate:.3},{from:250,types:[me],rate:.3,J:De(me)},{from:300,types:[me,ye,ke],rate:.3},{from:330,types:[ye,ke],X:xe,rate:.3},{from:380,types:[ye,ve,me],rate:.3},{from:450,types:[ve,he],rate:.4,J:(Ee=ve,()=>{$e(0,y,y/40).map((e=>{const a=_.x+i(e)*n,t=_.y+d(e)*r;Te(a,t,Ee)}))})},{from:500,types:[he,be],rate:.3},{from:550,types:[he,be],rate:.25},{from:600,types:[he,be,we],rate:.25},{from:650,types:[he,be],X:Se,rate:.4},{from:700,types:[he,be,we],rate:.25,J:De(be)},{from:720,types:[],rate:0,X:Re}];var Ee;const Ae=(e,a,t)=>({x:e,y:a,type:t,health:t.health,A:0,S:0,R:0,v:0,X:!!t.X}),Te=(e,a,t)=>ze.push(Ae(e,a,t)),ze=[],Be=[],Oe=(e,a,s)=>{const n=[["Base damage",T(_.k.damage.value)],["Attack speed",T(_.k.attackSpeed.value,2)],["Health",o(_.k.health.value)],["Regeneration",T(_.k.healthRegen.value,2)+"/s"],["Speed",T(_.k.speed.value,2)],["Health Drop",T(100*_.k.healthDrop.value)+"%"]];for(const e of _.T){const a=e.type.name;n.push([`${a} level`,e.level+1],...e.type.stats(e,e.type.m[e.level]).map((([e,t])=>[`${a} ${e}`,t])))}((e,a,t,s,n)=>{const r=a;let o=t/2;15*(n.length-1)<=s&&(e+=t/4);for(const[t,c]of n)B.text(e,a,`${t}:`,"#aaa"),B.text(e+o-5,a,`${c}`,"#fff",R),(a+=15)>r+s&&(a=r,e+=o)})(e,a,s,t-a-40,n)},Pe=(e,a,t)=>{const s=[["Survived",E(ce.runtime)],["Level",`${_.level+1}`],["Damage",T(ce.$)],["DPS",`${T(ce.$/ce.runtime,2)}`],["Kills",`${ce.j}`]];for(const n of s)B.text(e+t/2-5,a,n[0],"#ccc",R),B.text(e+t/2+5,a,n[1],"#fff",S),a+=15;return a},Le=()=>{switch(ce.state!==re&&(()=>{if(B.rect(50,0,a-50,20,"#600"),B.rect(50,0,_.health/_.k.health.value*(a-50),20,"#f66"),B.text(52,10,o(_.health)+"/"+o(_.k.health.value),"#fff",S,$),B.rect(50,20,a-50,12,"#999"),B.rect(50,20,_.H/_.I*(a-50),12,"#fff"),B.text(52,27,_.H+"/"+_.I,"#000",S,$),B.rect(0,0,50,32,"#000"),B.text(25,2,"level","#666",v,w),B.text(25,18,`${_.level+1}`,"#fff",v,w),B.text(n,35,E(ce.runtime),"#fff",v),ce.runtime<20){let e=t-30-15*s.length;for(const a of s)B.text(10,e,a,"#fff",S,w),e+=15}})(),ce.state){case ae:{let e=100;B.t(),B.text(n,e,"YOU'RE DEAD!","#f88",v,w,24),e+=45,e=Pe(50,e,a-100),e+=30,B.text(n,e,k,"#fff",v);break}case te:B.t(),B.text(n,10,"LEVEL UP","#fff",v,w);for(let e=0;e<ce.V.length;e++){const t=ce.V[e],s=_.V.filter((e=>e===t)).length,n=20,r=50+50*e;B.rect(n,r,a-40,40,e===ce.F?"#333":"#222"),B.rect(n,r,a-40,40,e===ce.F?"#aa3":"#444",!0),B.text(n+5,r+5,t.name,"#fff"),B.text(n+5,r+22,"function"==typeof t.description?t.description():t.description,"#ccc"),B.text(n+a-50,r+20,`${s}/${t.P}`,"#ccc",R,$)}Oe(20,210,a-40);break;case se:B.t(),B.text(n,40,"PAUSED","#fff",v,$),Oe(20,80,a-40);break;case ne:{B.t(),B.text(n,100,"YOU WON","#fff",v,$);let e=130;e=Pe(100,e,a-200),e+=30,B.text(n,e,k,"#fff",v);break}case re:B.t(),B.text(n,r-40,"MICRO","#fff",v,"bottom",68),B.text(n,r-40,"SURVIVORS","#fff",v,w,38),B.text(n,t-5,"by Kamen","#ccc",v,"bottom",10),L.globalAlpha=.5+.5*(.5*i(performance.now()/1e3*5)+.5),B.text(n,r+50,x,"#fff",v),L.globalAlpha=1}},Ue=()=>{L.reset(),L.clearRect(0,0,a,t),L.translate(-_.x+n,-_.y+r),(()=>{const e=50*o((_.x-n)/50),a=50*o((_.y-r)/50),t=50*c((_.x+n)/50),s=50*c((_.y+r)/50);for(let n=e;n<t;n+=50)for(let e=a;e<s;e+=50)B.rect(n,e,50,50,n%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000")})(),(()=>{for(const e of Be)B.o(e.x-3,e.y-3,(e.H??0)>=10?8:6,(e.health??0)>0?"#0c0":(e.H??0)<10?"#05f":"#ff0")})(),(()=>{for(const e of _.T)e.type.D(e,e.type.m[e.level]);B.rect(_.x-5,_.y-5,10,10,"#fff")})(),(()=>{for(const e of ze){const a=e.type;a.D(e.x,e.y,e.v>0?"#fff":void 0),a.X&&(B.rect(e.x-20,e.y+15,40,3,"#333"),B.rect(e.x-20,e.y+15,e.health/a.health*40,3,"#f33"))}})(),L.resetTransform(),(()=>{const e=l(1,_.K/.5);if(e>0){const a=O(80,"#ff000000",`rgba(255,0,0,${e})`);B.t(a)}const a=l(1,_.N/.1);if(a>0){const e=O(130,"#ffffff00",`rgba(255,255,255,${.15*a})`);B.t(e)}})(),Le()},Me=e=>{let t=0,s=[];for(const n of ze){const r=n.type;if(n.health<=0){Be.push({x:n.x,y:n.y,H:r.H}),f()<_.k.healthDrop.value&&Be.push({x:n.x-5+10*f(),y:n.y-5+10*f(),health:10}),ce.j+=1,s.push(t),t++;continue}n.v>0&&(n.v-=e);let o=n.S*e,c=n.R*e;const p=_.x-n.x,i=_.y-n.y,d=m(p,i);if(!n.X&&d>3*a)s.push(t),t++;else{if(n.A<=0){d<n.type.size-2&&(_.health-=r.damage,_.K=.5,n.A=r.A);const a=r.speed*e;o+=p/d*a,c+=i/d*a}else n.A-=e;if(n.x+=o,n.y+=c,h(n.S)>.1){const a=(n.S>0?-1:1)*e*(r.G??20);h(a)>h(n.S)?n.S=0:n.S+=a}else n.S=0;if(h(n.R)>.1){const a=(n.R>0?-1:1)*e*(r.G??20);h(a)>h(n.R)?n.R=0:n.R+=a}else n.R=0;t++}}let n=0;for(const e of s)ze.splice(e-n,1),n+=1},He=e=>{const s=f()*y,n=Math.max(a,t)/2,r=m(n,n)+15*f();ze.push(Ae(_.x+i(s)*r,_.y+d(s)*r,e))},Ie=e=>{switch(ce.state){case ee:{ce.runtime+=e,H.pause&&(ce.state=se),_.health<=0&&(ce.state=ae);const t=Ce.findIndex((e=>e.from>ce.runtime))-1,s=Ce[t<0?Ce.length-1:t];-2===t&&0===ze.length&&(ce.state=ne),s&&(t!==ce.W&&(ce.W=t,s.X&&He(s.X),s.J?.()),ce.q>s.rate?(s.types.length>0&&He((a=s.types)[p(f()*(a.length-1))]),ce.q=0):ce.q+=e);break}case ne:case ae:case re:M.enter&&(Object.assign(_,Z(q)),Object.assign(ce,oe),ce.state=ee,ze.length=0,Be.length=0);break;case te:if(H.up&&ce.F>0&&ce.F--,H.down&&ce.F<ce.V.length-1&&ce.F++,H.enter){const e=ce.V[ce.F];e.apply(),_.V.push(e),ce.state=ee}break;case se:(H.pause||H.enter)&&(ce.state=ee)}var a},Ye=()=>{for(const e in H)H[e]=!1},Ke=e=>{let a=0,t=0;M.up&&(t-=1),M.down&&(t+=1),M.left&&(a-=1),M.right&&(a+=1);const s=_.k.speed.value*e,c=m(a,t);c>0&&(_.x+=a/c*s,_.y+=t/c*s);const p=n,i=r;if(_.C=g(M.targetY-i,M.targetX-p),_.H>=_.I){_.level+=1,_.H-=_.I,_.I+=10;const e=J.filter((e=>!(e.L&&!e.L())&&!(e.P&&_.V.filter((a=>a===e)).length>=e.P)));ce.V=(e=>{for(let a=e.length-1;a>=0;a--){const t=o(f()*(a+1));[e[a],e[t]]=[e[t],e[a]]}return e})(e).slice(0,3),ce.V.length>0&&(ce.state=te),_.health+=5}_.K>0&&(_.K-=e),_.N>0&&(_.N-=e),_.health=l(_.k.health.value,_.health+_.k.healthRegen.value*e);for(const a of _.T)if(a.u+=e,a.A<=0){const e=a.type.m[a.level];a.type.u(a,e),a.A=e.h*_.k.attackSpeed.value}else a.A-=e},Ne=e=>{let a=0,t=[];for(const s of Be){const n=_.x-s.x,r=_.y-s.y,o=m(n,r);if(o<10)_.health=l(_.k.health.value,_.health+(s.health??0)),_.H+=s.H??0,_.N=.1,t.push(a);else if(o<_.k.pickupDistance.value){const a=(_.k.pickupDistance.value+10-o)*e*2;s.x+=n/o*a,s.y+=r/o*a}a++}let s=0;for(const e of t)Be.splice(e-s,1),s+=1};let Ve=0;const We=e=>{requestAnimationFrame(We);const a=(e-Ve)/1e3;var t;Ve=e,Ue(),Ie(t=a),ce.state===ee&&(Me(t),Ne(t),Ke(t)),Ye()};return e.appendChild(P),requestAnimationFrame(We),[_,ce]}