function microSurvivors(w=document.body,N=400,L=400){let s=["WASD/Arrows to move","Mouse to aim","Survive","Kill end boss"],n=N/2,i=L/2;function h(e){var a=Math.floor(e/60),e=Math.floor(e%60);return a.toString().padStart(2,"0")+":"+e.toString().padStart(2,"0")}let p=e=>c(e*(180/Math.PI)),c=(e,a=0)=>e.toFixed(a),F=(e,a,t,r)=>Math.hypot(t-e,r-a),U=()=>Math.random();let _=e=>e[Math.round(U()*(e.length-1))],u={rect(e,a,t,r,s){b.fillStyle=s,b.fillRect(e,a,t,r)},t(e="rgba(0,0,0,0.9)"){b.fillStyle=e,b.fillRect(0,0,N,L)},i(e,a,t,r){b.fillStyle=r,b.fillRect(e-t/2,a-t/2,t,t)},h(e,a,t,r){b.fillStyle=r,b.beginPath(),b.moveTo(e,a-t/2),b.lineTo(e-t/2,a+t/2),b.lineTo(e+t/2,a+t/2),b.fill()},text(e,a,t,r,s="left",n="top",i=14){b.font=i+"px monospace",b.fillStyle=r,b.textAlign=s,b.textBaseline=n,b.fillText(t,e,a)},o(e,a,t,r){b.fillStyle=r,b.beginPath(),b.arc(e,a,t,0,2*Math.PI),b.fill()}},x=(e,a,t,r,s)=>{var n,i,h=a,o=t/2;15*s.length<r&&(e+=t/4);for([n,i]of s)u.text(e,a,n+":","#aaa"),u.text(e+o-5,a,""+i,"#fff","right"),h+r<(a+=15)&&(a=h,e+=o)},M=(e,a,t)=>{e=b.createRadialGradient(n,i,e,n,i,n);return e.addColorStop(0,a),e.addColorStop(1,t),e},k=document.createElement("canvas"),b=(k.width=N,k.height=L,k.getContext("2d")??(()=>{throw new Error})()),E={arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",w:"up",s:"down",a:"left",d:"right",enter:"enter",escape:"pause",p:"pause"},I={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1,targetX:0,targetY:0},H={up:!1,down:!1,left:!1,right:!1,enter:!1,pause:!1},a=(e,a)=>{e=E[e.key.toLowerCase()];e&&(I[e]=a,H[e]=a)};var e="addEventListener";document[e]("keydown",e=>a(e,!0)),document[e]("keyup",e=>a(e,!1)),k[e]("mousemove",e=>{var a=k.getBoundingClientRect();I.targetX=e.clientX-a.left,I.targetY=e.clientY-a.top});let W={l:0,m:1,g:2};var e=a=>{let t=a[0];var r=[a[0]];for(let e=1;e<a.length;e++)t={...t,...a[e]},r[e]=t;return r},t={name:"Saw Blades",type:W.l,v:e([{damage:5,range:50,rotationSpeed:Math.PI/2,u:.1,blades:1,size:10},{blades:2},{damage:10,rotationSpeed:Math.PI/1.5},{rotationSpeed:Math.PI/1.25,size:15},{blades:3},{damage:15},{blades:4}])},r={name:"Sword",type:W.m,v:e([{damage:8,angle:Math.PI/4,range:80,M:.5},{damage:13},{angle:Math.PI/4*1.2,range:90},{damage:18},{damage:23},{damage:28,angle:Math.PI/4*1.5},{damage:33,angle:Math.PI/4*1.7,range:120}])},e={name:"Barbed Wire",type:W.g,v:e([{range:40,damage:2,M:.75},{range:60},{damage:3},{range:70},{range:80},{damage:4}])};let R=e=>({type:e,k:0,R:0,level:0});var o=t=>(e,a)=>a+e.level*t,f=e=>()=>e;let j={S:[r],T:{health:[f(100),o(10)],speed:[f(45),o(.2)],healthRegen:[f(.1),o(.01)],pickupDistance:[f(50)],damage:[o(.3)],attackSpeed:[f(1)],healthDrop:[f(.01)]}};var o=(a,t)=>e=>e.T[a].push("base",(e,a)=>a+t),f=(a,t)=>e=>e.T[a].push("multiplier",(e,a)=>a*t),l=(h,e)=>{let o;return{name:e,description:()=>{var e=o?.D??$.S.find(e=>e.type===h);if(!e)return"New weapon";if(o?.level===e.level)return o.A;var a,t,r=e.type.v[e.level],s=e.type.v[e.level+1],n=[];for(a in s)s[a]!==r[a]&&(t=s[a]-r[a],t="angle"===a?p(t)+"°":c(t),n.push(`+${t} `+a));var i=n.join(", ");return o={level:e.level,D:e,A:i},i},weight:1,apply:e=>{var a=e.S.find(e=>e.type===h);a?a.level++:e.S.push(R(h))},C:h.v.length}};let J=[{name:"Speed boost",description:"+25% speed",weight:1,apply:f("speed",1.25),C:5},{name:"Speed base",description:"+1 base speed",weight:1,apply:o("speed",1),C:5},{name:"Heal",description:"+25 health",weight:1,P:e=>e.health+25<e.T.health.value,apply:e=>e.health+=25,C:5},{name:"Max health",description:"+25 max health, +5 health",weight:1,apply:e=>{e.T.health.push("base",(e,a)=>a+25),e.health+=5},C:5},{name:"Health drop",description:"+1% health drop chance",weight:1,apply:o("healthDrop",.01),C:5},{name:"Regen",description:"+0.1/s health regen",weight:1,apply:o("healthRegen",.1),C:5},{name:"Regen boost",description:"+5% health regen",weight:1,apply:f("healthRegen",1.05),C:5},{name:"Pickup range",description:"+10 pickup range",weight:1,apply:o("pickupDistance",10),C:5},{name:"Damage",description:"+1 damage",weight:1,apply:o("damage",1),C:5},{name:"Attack speed",description:"+5% attack speed",weight:1,apply:o("attackSpeed",-.05),C:5},l(t,"Saw Blades"),l(r,"Sword"),l(e,"Barbed Wire")],d=(e=[],a=[])=>({push(e,a){this[e]=[...this[e],a]},base:[...e],multiplier:[...a],B:null,get value(){var e;return this.B?.base===this.base&&this.B?.multiplier===this.multiplier&&this.B?.N===$.level?this.B.value:(e=this.base.reduce((e,a)=>a($,e),0)*this.multiplier.reduce((e,a)=>a($,e),1),this.B={base:this.base,multiplier:this.multiplier,N:$.level,value:e},e)}}),Q=e=>({type:e,x:0,y:0,level:0,L:0,U:5,health:100,I:0,H:0,W:0,$:0,T:{speed:d(e.T.speed),health:d(e.T.health),healthRegen:d(e.T.healthRegen),pickupDistance:d(e.T.pickupDistance),damage:d(e.T.damage),attackSpeed:d(e.T.attackSpeed),healthDrop:d(e.T.healthDrop)},O:[],S:e.S.map(e=>R(e))}),$=Q(j),O={RUNNING:0,K:1,Y:2,G:3,WIN:4,V:5},K={X:-1,runtime:0,q:0,F:0,_:0,O:[],j:0},Y={state:O.V,...K};let m=(e,n)=>(t,r,s)=>{e.forEach((e,a)=>{u.i(t+a,r+a,n,s??e)})};var f=(e,n)=>(t,r,s)=>{e.forEach((e,a)=>{u.h(t+a,r+a,n,s??e)})},o=(e,n)=>(t,r,s)=>{e.forEach((e,a)=>{u.o(t+a,r+a,n,s??e)})},t={health:10,speed:26,damage:1,R:1,L:1,size:10,J:m(["#aaa"],10)},r={health:50,speed:26,damage:1,R:1,L:2,size:10,J:m(["#aaa","#faa"],10)},l={health:100,speed:30,damage:2,R:1,L:3,size:10,J:m(["#aaa","#faa","#4a4"],10)},e={health:20,speed:35,damage:2,R:1,L:2,size:10,J:f(["#999"],10)},g={health:40,speed:35,damage:2,R:1,L:3,size:10,J:f(["#999","#0ac"],10)},v={health:60,speed:35,damage:3,R:1,L:4,size:10,J:f(["#999","#0ac","#966"],10)},f={health:1e3,speed:35,damage:10,R:1,L:50,Z:!0,ee:80,size:20,J:f(["#faa"],20)},y={health:10,speed:40,damage:1,R:1,L:3,size:10,J:o(["#999"],5)},S={health:20,speed:40,damage:1,R:1,L:4,size:10,J:o(["#999","#0ac"],5)},T={health:50,speed:40,damage:1,R:1,L:5,size:10,J:o(["#999","#0ac","#4ca"],5)},o={health:1e3,speed:40,damage:5,R:1,L:4,Z:!0,ee:80,size:16,J:o(["#faa"],8)};var D;let G=[{from:0,types:[t],rate:.4,ae:()=>{var a=2*Math.PI/40;for(let e=0;e<2*Math.PI;e+=a){var t=$.x+Math.cos(e)*n,r=$.y+Math.sin(e)*i;V.push(A(t,r,D))}}},{from:30,types:[D=t,e],rate:.4},{from:80,types:[t,e],rate:.1},{from:120,types:[e],rate:.2,Z:{health:500,speed:30,damage:10,R:1,L:20,size:20,J:(e,a,t)=>m(["#faa"],20),Z:!0}},{from:150,types:[e,y],rate:.3},{from:200,types:[e,y],rate:.15},{from:250,types:[r],rate:.2},{from:300,types:[r,g,y],rate:.2},{from:330,types:[g,y],Z:f,rate:.2},{from:380,types:[g,S,r],rate:.15},{from:450,types:[S,l],rate:.15},{from:500,types:[l,v],rate:.1},{from:550,types:[l,v],rate:.1},{from:600,types:[l,v,T],rate:.1},{from:650,types:[l,v],Z:o,rate:.15},{from:700,types:[l,v,T],rate:.1},{from:720,types:[],rate:0,Z:{health:1e4,speed:55,damage:5,R:1,L:0,Z:!0,ee:1e3,size:50,J:(e,a,t)=>{u.o(e,a,25,t??"#faa"),u.i(e,a,25,t??"#0ac"),u.h(e,a,23,t??"#faa")}}}],A=(e,a,t)=>({x:e,y:a,type:t,health:t.health,R:0,te:0,re:0,se:0,Z:!!t.Z}),V=[],X={ne:0,ie:1},q=[];function z(e,a,t){var r,s=[["Base damage",c($.T.damage.value)],["Attack speed",c($.T.attackSpeed.value,2)],["Health",Math.floor($.T.health.value)],["Regeneration",c($.T.healthRegen.value,2)+"/s"],["Speed",c($.T.speed.value,2)],["Health Drop",c(100*$.T.healthDrop.value)+"%"]];for(r of $.S){var n=r.type.name;switch(r.type.type){case W.m:var i=r.type.v[r.level];s.push([n+" level",r.level+1]),s.push([n+" damage",c(i.damage)]),s.push([n+" range",c(i.range)]),s.push([n+" angle",p(i.angle)+"°"]);break;case W.l:i=r.type.v[r.level];s.push([n+" level",r.level+1]),s.push([n+" damage",c(i.damage)]),s.push([n+" range",c(i.range)]),s.push([n+" blades",c(i.blades)]),s.push([n+" size",c(i.size)]);break;case W.g:var h=r.type.v[r.level];s.push([n+" level",r.level+1]),s.push([n+" damage",c(h.damage)]),s.push([n+" range",c(h.range)])}}x(e,a,t,L-a-20,s)}function C(e,a,t){var r;for(r of[["Survived for",h(Y.runtime)],["Level",""+($.level+1)],["Damage done",c(Y.q)],["DPS",""+c(Y.q/Y.runtime,2)],["Kills",""+Y.F]])u.text(e+t/2-5,a,r[0],"#ccc","right"),u.text(e+t/2+5,a,r[1],"#fff","left"),a+=15;return a}function P(){if(Y.state!==O.V&&(u.rect(50,0,N-50,20,"#600"),u.rect(50,0,$.health/$.T.health.value*(N-50),20,"#f66"),u.text(52,10,Math.floor($.health)+" / "+Math.floor($.T.health.value),"#fff","left","middle"),u.rect(50,20,N-50,12,"#999"),u.rect(50,20,$.L/$.U*(N-50),12,"#fff"),u.text(52,27,$.L+" / "+$.U,"#000","left","middle"),u.rect(0,0,50,32,"#000"),u.text(25,2,"level","#666","center","top"),u.text(25,18,""+($.level+1),"#fff","center","top"),u.text(N/2,35,h(Y.runtime),"#fff","center"),Y.runtime<20)){let e=L-30-15*s.length;for(var a of s)u.text(10,e,a,"#fff","left","top"),e+=15}switch(Y.state){case O.K:u.t(),u.text(N/2,100,"YOU'RE DEAD!","#f88","center","top",24),e=C(50,145,N-100),e+=30,u.text(N/2,e,"Press ENTER to restart","#fff","center");break;case O.Y:u.t(),u.text(N/2,10,"LEVEL UP","#fff","center","top");for(let e=0;e<Y.O.length;e++){let a=Y.O[e];var t=$.O.filter(e=>e===a).length,r=50+50*e;b.textAlign="left",b.textBaseline="top",b.fillStyle=e===Y.j?"#333":"#222",b.fillRect(20,r,N-40,40),b.strokeStyle=e===Y.j?"#aa3":"#444",b.strokeRect(20,r,N-40,40),b.fillStyle="#fff",b.fillText(a.name,25,5+r),b.fillStyle="#ccc",b.fillText("function"==typeof a.description?a.description():a.description,25,22+r),u.text(20+N-50,20+r,t+"/"+a.C,"#ccc","right","middle")}z(20,210,N-40);break;case O.G:u.t(),u.text(N/2,100,"PAUSED","#fff","center","middle"),z(20,110,N-40);break;case O.WIN:u.t(),u.text(N/2,100,"YOU WON","#fff","center","middle");var e=C(100,130,N-200);e+=30,u.text(N/2,e,"Press ENTER to restart","#fff","center");break;case O.V:u.t(),u.text(N/2,L/2-40,"MICRO","#fff","center","bottom",68),u.text(N/2,L/2-40,"SURVIVORS","#fff","center","top",38),u.text(N/2,L-5,"by Kamen","#ccc","center","bottom",10),b.globalAlpha=.5+.5*(.5*Math.cos(performance.now()/1e3*5)+.5),u.text(N/2,L/2+50,"Press ENTER to start","#fff","center"),b.globalAlpha=1}}function B(){b.reset(),b.clearRect(0,0,k.width,k.height),b.translate(-$.x+N/2,-$.y+L/2);var e,a,t,r=50*Math.floor(($.x-N/2)/50),s=50*Math.floor(($.y-L/2)/50),n=50*Math.ceil(($.x+N/2)/50),i=50*Math.ceil(($.y+L/2)/50);for(let a=r;a<n;a+=50)for(let e=s;e<i;e+=50)u.rect(a,e,50,50,a%100==0?e%100==0?"#000":"#111":e%100==0?"#111":"#000");for(e of q)u.i(e.x-3,e.y-3,10<=(e.L??0)?8:6,0<(e.health??0)?"#0c0":(e.L??0)<10?"#05f":"#ff0");for(a of $.S)switch(a.type.type){case W.l:var h=a.type.v[a.level],o=2*Math.PI/h.blades,p=a.k*h.rotationSpeed;for(let e=0;e<h.blades;e++){var c=p+o*e,f=$.x+Math.cos(c)*h.range,c=$.y+Math.sin(c)*h.range;u.o(f,c,h.size/2,"#fff")}break;case W.m:var l=a.type.v[a.level],d=l.M*$.T.attackSpeed.value,d=.2*(a.R/d);0<d&&(m=l.angle/2,b.fillStyle=`rgba(255,255,255,${d})`,b.beginPath(),b.moveTo($.x,$.y),b.lineTo($.x+Math.cos($.$-m)*l.range,$.y+Math.sin($.$-m)*l.range),b.arc($.x,$.y,l.range,$.$-m,$.$+m),b.lineTo($.x,$.y),b.fill());break;case W.g:var d=a.type.v[a.level],l=d.M*$.T.attackSpeed.value,m=a.R/l,g=.15+.02*Math.cos(2*m*Math.PI);u.o($.x,$.y,d.range,`rgba(255,0,0,${g})`)}u.rect($.x-5,$.y-5,10,10,"#fff");for(t of V){var v=t.type;v.J(t.x,t.y,0<t.se?"#fff":void 0),v.Z&&(u.rect(t.x-20,t.y+15,40,3,"#333"),u.rect(t.x-20,t.y+15,t.health/v.health*40,3,"#f33"))}b.resetTransform(),0<(r=Math.min(1,$.H/.5))&&(r=M(80,"rgba(255,0,0,0)",`rgba(255,0,0,${r})`),u.t(r)),0<(r=Math.min(1,$.W/.1))&&(r=M(130,"rgba(255,255,255,0)",`rgba(255,255,255,${.15*r})`),u.t(r)),P()}function Z(s){var e,a,t,r=s;switch(Y.state){case O.RUNNING:(Y.runtime+=r,H.pause)?Y.state=O.G:$.health<=0?Y.state=O.K:(a=G.findIndex(e=>e.from>Y.runtime)-1,e=G[a<0?G.length-1:a],-2==a&&0===V.length&&(Y.state=O.WIN),e&&(a!==Y.X&&(Y.X=a,e.Z&&ee(e.Z),e.ae)&&e.ae(),Y._>e.rate?(0<e.types.length&&ee(_(e.types)),Y._=0):Y._+=r));break;case O.WIN:case O.K:case O.V:I.enter&&(()=>{for(var e in $=Q(j),K)Y[e]=K[e];Y.state=O.RUNNING,V.length=0,q.length=0})();break;case O.Y:H.up&&0<Y.j&&Y.j--,H.down&&Y.j<Y.O.length-1&&Y.j++,H.enter&&((a=Y.O[Y.j]).apply($),$.O.push(a),Y.state=O.RUNNING);break;case O.G:(H.pause||H.enter)&&(Y.state=O.RUNNING)}if(Y.state===O.RUNNING){{var n,i=s;let t=0,r=[];for(n of V){var h=n.type;if(n.health<=0)q.push({x:n.x,y:n.y,type:X.ie,L:h.L}),U()<$.T.healthDrop.value&&q.push({x:n.x-5+10*U(),y:n.y-5+10*U(),type:X.ne,health:10}),Y.F+=1,r.push(t);else{0<n.se&&(n.se-=i);let e=n.te*i,a=n.re*i;var o,p=$.x-n.x,c=$.y-n.y,f=Math.sqrt(p*p+c*c);!n.Z&&3*N<f?r.push(t):(n.R<=0?(f<n.type.size-2&&($.health-=h.health,$.H=.5,n.R=h.R),o=h.speed*i,e+=p/f*o,a+=c/f*o):n.R-=i,n.x+=e,n.y+=a,!(.1<Math.abs(n.te))||(p=(0<n.te?-1:1)*i*(h.ee??20),Math.abs(p)>Math.abs(n.te))?n.te=0:n.te+=p,!(.1<Math.abs(n.re))||(c=(0<n.re?-1:1)*i*(h.ee??20),Math.abs(c)>Math.abs(n.re))?n.re=0:n.re+=c)}t++}let a=0;for(let e of r)V.splice(e-a,1),a+=1}{var l,d=s;let e=0,a=[];for(l of q){var m,g=$.x-l.x,v=$.y-l.y,u=Math.sqrt(g*g+v*v);if(u<10){switch(l.type){case X.ne:$.health=Math.min($.T.health.value,$.health+(l.health??0));break;case X.ie:$.L+=l.L??0}$.W=.1,a.push(e)}else u<$.T.pickupDistance.value&&(m=($.T.pickupDistance.value+10-u)*d*2,l.x+=g/u*m,l.y+=v/u*m);e++}let t=0;for(let e of a)q.splice(e-t,1),t+=1}{var M=s;let e=0,a=0;I.up&&--a,I.down&&(a+=1),I.left&&--e,I.right&&(e+=1);var k,s=$.T.speed.value*M,b=Math.sqrt(e*e+a*a);0<b&&($.x+=e/b*s,$.y+=a/b*s),b=N/2,s=L/2,$.$=Math.atan2(I.targetY-s,I.targetX-b),$.L>=$.U&&($.level+=1,$.L-=$.U,$.U+=10,s=J.filter(a=>!(a.P&&!a.P($)||a.C&&$.O.filter(e=>e===a).length>=a.C)),Y.O=(a=>{for(let e=a.length-1;0<=e;e--){var t=Math.floor(U()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a})(s).slice(0,3),0<Y.O.length&&(Y.state=O.Y),$.health+=5),0<$.H&&($.H-=M),0<$.W&&($.W-=M),$.health=Math.min($.T.health.value,$.health+$.T.healthRegen.value*M);for(k of $.S)switch(k.k+=M,k.type.type){case W.l:var y=k.type.v[k.level],w=y.damage+$.T.damage.value;if(k.R<=0){k.R=y.u*$.T.attackSpeed.value;var x=2*Math.PI/y.blades,E=k.k*y.rotationSpeed;for(let e=0;e<y.blades;e++){var R,S=E+x*e,T=$.x+Math.cos(S)*y.range,D=$.y+Math.sin(S)*y.range;for(R of V)F(R.x,R.y,T,D)<y.size/2+R.type.size+2&&(R.health-=w,R.se=.1,R.te=20*Math.cos(S),R.re=20*Math.sin(S),Y.q+=w)}}else k.R-=M;break;case W.m:0<k.R?k.R-=M:(((e,a)=>{var t,r=a.v[e.level],s=r.damage+$.T.damage.value,a=r.angle/2,n=$.$-a,i=$.$+a;for(t of V){var h=t.x-$.x,o=t.y-$.y,p=Math.atan2(o,h),h=Math.sqrt(h*h+o*o),o=Math.atan2(t.type.size/2,h);n<p+o&&p-o<i&&h-t.type.size/2<r.range&&(t.health-=s,t.se=.1,t.te=25*Math.cos(p),t.re=25*Math.sin(p),Y.q+=s)}})(k,k.type),k.R=k.type.v[k.level].M*$.T.attackSpeed.value);break;case W.g:if(0<k.R)k.R-=M;else{var A,z=k.type.v[k.level],C=z.damage+$.T.damage.value;for(A of V){var P=A.x-$.x,B=A.y-$.y;let e=Math.sqrt(P*P+B*B);e<z.range&&(A.health-=C,A.se=.1,Y.q+=C)}k.R=k.type.v[k.level].M*$.T.attackSpeed.value}}}}for(t in H)H[t]=!1}function ee(e){var a=U()*Math.PI*2,t=Math.max(N,L)/2,t=Math.sqrt(t*t*2)+15*U();V.push(A($.x+Math.cos(a)*t,$.y+Math.sin(a)*t,e))}let ae=0;return w.appendChild(k),requestAnimationFrame(function e(a){requestAnimationFrame(e);var t=(a-ae)/1e3;ae=a,B(),Z(t)}),[$,Y]}